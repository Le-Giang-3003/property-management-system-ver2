@page
@using PropertyManagementSystemVer2.DAL.Enums
@model PropertyManagementSystemVer2.Web.Pages.Landlord.PropertiesModel
@{
    ViewData["Title"] = "Quản lý Bất động sản";
}

<style>
    .image-slider {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 8px;
    }
    .image-slider::-webkit-scrollbar { height: 6px; }
    .image-slider::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .image-slider img {
        scroll-snap-align: start;
        flex: 0 0 100%;
        height: 350px;
        object-fit: cover;
        border-radius: 12px;
        border: 1px solid var(--border);
    }
    .existing-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }
    .existing-img-card {
        position: relative;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
    }
    .existing-img-card img {
        width: 100%;
        height: 90px;
        object-fit: cover;
        display: block;
    }
    .existing-img-card .img-actions {
        padding: 6px;
        background: var(--bg-card);
        text-align: center;
    }
    .existing-img-card .primary-badge {
        position: absolute;
        top: 4px; left: 4px;
        background: var(--accent-light);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
    }

    /* Form Additions */
    .form-group-with-icon { margin-bottom: 1rem; }
    .input-icon-wrapper { position: relative; }
    .input-icon {
        position: absolute; left: 1rem; top: 50%; transform: translateY(-50%);
        color: #6b7280; pointer-events: none; z-index: 1;
    }
    .input-icon.textarea-icon { top: 1rem; transform: none; }
    .form-control-with-icon {
        width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem;
        background: var(--bg-input); border: 1px solid var(--border);
        border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; transition: all 0.2s;
    }
    .form-control-with-icon:focus {
        outline: none; border-color: var(--accent-light); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    textarea.form-control-with-icon { padding-left: 2.75rem; resize: vertical; }
    select.form-control-with-icon { padding-left: 2.75rem; cursor: pointer; }

    .custom-checkbox {
        display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none;
        padding: 0.875rem 1.25rem; background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s; flex: 1;
    }
    .custom-checkbox:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(99, 102, 241, 0.3); }
    .custom-checkbox input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .custom-checkbox-box {
        position: relative; width: 20px; height: 20px; border: 2px solid #4b5563;
        border-radius: 4px; background: transparent; transition: all 0.2s; flex-shrink: 0;
        display: flex; align-items: center; justify-content: center;
    }
    .custom-checkbox input[type="checkbox"]:checked ~ .custom-checkbox-box {
        background: var(--accent); border-color: var(--accent);
    }
    .custom-checkbox-check {
        width: 12px; height: 10px; color: white; opacity: 0; transform: scale(0.8); transition: all 0.2s;
    }
    .custom-checkbox input[type="checkbox"]:checked ~ .custom-checkbox-box .custom-checkbox-check {
        opacity: 1; transform: scale(1);
    }
    .custom-checkbox-content {
        display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-primary); font-weight: 500;
    }
    .custom-checkbox-content svg, .custom-checkbox-content i { color: #6b7280; flex-shrink: 0; }
    .custom-checkbox:hover .custom-checkbox-content svg, .custom-checkbox:hover .custom-checkbox-content i { color: #9ca3af; }
    .custom-checkbox input[type="checkbox"]:checked ~ .custom-checkbox-content svg, .custom-checkbox input[type="checkbox"]:checked ~ .custom-checkbox-content i { color: var(--accent-light); }

    .modal-create-property {
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: 16px; width: 100%; max-width: 720px; max-height: 90vh;
        overflow: hidden; display: flex; flex-direction: column;
    }

    /* Modal Detail Styles */
    .dt-header { margin-bottom: 24px; }
    .dt-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); }
    .dt-address { display: flex; align-items: center; gap: 6px; color: var(--text-muted); font-size: 14px; margin-bottom: 16px; }
    
    .dt-price-box {
        display: flex; align-items: baseline; gap: 8px; margin-bottom: 24px;
    }
    .dt-price-main { font-size: 28px; font-weight: 700; color: var(--accent-light); }
    .dt-price-label { color: var(--text-muted); font-size: 14px; }

    .dt-specs {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;
    }
    .spec-box {
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: 12px; padding: 16px; text-align: center;
    }
    .spec-icon { color: var(--accent-light); margin-bottom: 8px; display: flex; justify-content: center; }
    .spec-label { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
    .spec-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }

    .dt-section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); }
    .section-content { color: var(--text-secondary); line-height: 1.6; font-size: 15px; white-space: pre-wrap; }

    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .detail-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);
    }
    .detail-label { display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-size: 14px; }
    .detail-value { font-weight: 600; color: var(--text-primary); font-size: 14px; }
    .detail-value-primary { color: var(--accent-light); font-size: 16px; }

    .amenities-list { display: flex; flex-wrap: wrap; gap: 10px; }
    .amenity-badge {
        background: var(--accent-glow); color: var(--accent-light);
        padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500;
        display: inline-flex; align-items: center; gap: 6px;
    }
</style>

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-20" style="padding: 12px 16px; background: var(--success-bg); color: var(--success); border-radius: var(--radius-sm); border: 1px solid var(--success);">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-20" style="padding: 12px 16px; background: var(--danger-bg); color: var(--danger); border-radius: var(--radius-sm); border: 1px solid var(--danger);">
        @TempData["ErrorMessage"]
    </div>
}

<div class="mb-20" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
        <div class="page-title">Bất động sản của bạn</div>
        <div class="page-desc">Quản lý các phòng trọ/căn hộ bạn đang cho thuê</div>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i data-feather="plus" style="width: 16px; height: 16px;"></i> Thêm BDS mới
    </button>
</div>

<form method="get" id="filterForm" class="filter-bar mb-20" style="margin-bottom: 20px;">
    <div class="header-search" style="flex: 1; min-width: 250px;">
        <i data-feather="search" style="color: var(--text-muted); width: 14px;"></i>
        <input type="text" name="SearchTerm" value="@Model.SearchTerm" placeholder="Tìm kiếm tên, địa chỉ..." style="width: 100%; border: none; outline: none; background: transparent; color: inherit; padding-left: 8px;" />
    </div>
    <input type="hidden" name="StatusFilter" id="statusFilter" value="@Model.StatusFilter" />
    <button type="button" class="btn btn-sm @(Model.StatusFilter == null ? "btn-primary" : "btn-ghost")" onclick="setFilter('')">Tất cả (@Model.AllProperties.Count)</button>
    <button type="button" class="btn btn-sm @(Model.StatusFilter == PropertyStatus.Available ? "btn-primary" : "btn-ghost")" onclick="setFilter('Available')">Đang đăng (@Model.AllProperties.Count(p => p.Status.ToString() == "Available"))</button>
    <button type="button" class="btn btn-sm @(Model.StatusFilter == PropertyStatus.Rented ? "btn-primary" : "btn-ghost")" onclick="setFilter('Rented')">Đã thuê (@Model.AllProperties.Count(p => p.Status.ToString() == "Rented"))</button>
    <button type="button" class="btn btn-sm @(Model.StatusFilter == PropertyStatus.Pending ? "btn-primary" : "btn-ghost")" onclick="setFilter('Pending')">Chờ duyệt (@Model.AllProperties.Count(p => p.Status.ToString() == "Pending"))</button>
    <button type="button" class="btn btn-sm @(Model.StatusFilter == PropertyStatus.Rejected ? "btn-primary" : "btn-ghost")" onclick="setFilter('Rejected')">Từ chối (@Model.AllProperties.Count(p => p.Status.ToString() == "Rejected"))</button>
    <button type="button" class="btn btn-sm @(Model.StatusFilter == PropertyStatus.Blocked ? "btn-primary" : "btn-ghost")" onclick="setFilter('Blocked')">Bị khóa (@Model.AllProperties.Count(p => p.Status.ToString() == "Blocked"))</button>
</form>

<div class="property-grid">
    @if (Model.Properties != null && Model.Properties.Any())
    {
        foreach (var prop in Model.Properties)
        {
            <div class="property-card" style="position: relative;">
                @if (!string.IsNullOrEmpty(prop.ThumbnailUrl))
                {
                    <img class="property-image" src="@prop.ThumbnailUrl" alt="@prop.Title" />
                }
                else
                {
                    <div class="property-image-placeholder">🏠</div>
                }
                <div class="property-body">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span class="property-type-badge">
                            @(prop.PropertyType.ToString() switch {
                                "Apartment" => "Căn hộ",
                                "House" => "Nhà phố",
                                "Studio" => "Căn hộ studio",
                                "Room" => "Phòng trọ",
                                _ => prop.PropertyType.ToString()
                            })
                        </span>
                        @if (prop.Status.ToString() == "Available")
                        {
                            <span class="badge badge-success">Đang đăng</span>
                        }
                        else if (prop.Status.ToString() == "Approved")
                        {
                            <span class="badge badge-info" title="Vui lòng bấm 'Đăng bài' để đăng">Đã duyệt</span>
                        }
                        else if (prop.Status.ToString() == "Unavailable")
                        {
                            <span class="badge badge-gray">Tạm ẩn</span>
                        }
                        else if (prop.Status.ToString() == "Pending")
                        {
                            <span class="badge badge-warning">Chờ duyệt</span>
                        }
                        else if (prop.Status.ToString() == "Rented")
                        {
                            <span class="badge badge-secondary">Đã thuê</span>
                        }
                        else if (prop.Status.ToString() == "Rejected")
                        {
                            <span class="badge badge-danger">Từ chối</span>
                        }
                        else if (prop.Status.ToString() == "Blocked")
                        {
                            <span class="badge" style="background: rgba(52, 58, 64, 0.1); color: #343a40; border: 1px solid #343a40;">Bị khóa</span>
                        }
                        else
                        {
                            <span class="badge badge-gray">@prop.Status</span>
                        }
                    </div>
                    <div class="property-title">@prop.Title</div>
                    <div class="property-address"><i data-feather="map-pin" style="width: 12px; height: 12px;"></i> @prop.City</div>
                    
                    <div class="property-specs">
                        <span class="spec-item"><i data-feather="grid" style="width: 13px; height: 13px;"></i> ID: @prop.Id</span>
                        <span class="spec-item"><i data-feather="layout" style="width: 13px; height: 13px;"></i> @prop.Area m²</span>
                    </div>

                    @if (prop.Status.ToString() == "Rejected" || prop.Status.ToString() == "Blocked")
                    {
                        <div style="margin-top: 10px; padding: 10px; background-color: var(--danger-bg); border-radius: 8px; border: 1px solid var(--danger);">
                            <div style="color: var(--danger); font-size: 13px; font-weight: 600; margin-bottom: 4px;">@(prop.Status.ToString() == "Blocked" ? "Lý do khóa bài:" : "Lý do từ chối:")</div>
                            <div style="font-size: 13px; color: var(--danger);">@prop.RejectionReason</div>
                        </div>
                    }

                    <div style="border-top: 1px solid var(--border); padding-top: 12px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div class="property-price">@prop.MonthlyRent.ToString("N0") VNĐ</div>
                            <div class="property-price-sub">/tháng</div>
                        </div>
                            <div style="display: flex; gap: 6px;">
                                @{
                                    var propJson = System.Text.Json.JsonSerializer.Serialize(prop);
                                }
                                @if (prop.Status.ToString() == "Approved" || prop.Status.ToString() == "Unavailable")
                                {
                                    <form method="post" asp-page-handler="Publish" style="display:inline;">
                                        <input type="hidden" name="propertyId" value="@prop.Id" />
                                        <button type="submit" class="btn btn-sm btn-success" title="Đăng bài này lên để người thuê nhìn thấy">
                                            Đăng bài
                                        </button>
                                    </form>
                                }
                                else if (prop.Status.ToString() == "Available")
                                {
                                    <form method="post" asp-page-handler="Unpublish" style="display:inline;">
                                        <input type="hidden" name="propertyId" value="@prop.Id" />
                                        <button type="submit" class="btn btn-sm btn-warning" title="Tạm ẩn bài đăng này khỏi danh sách">
                                            Tạm ẩn
                                        </button>
                                    </form>
                                }
                                else if (prop.Status.ToString() == "Rejected")
                                {
                                    <form method="post" asp-page-handler="Resubmit" style="display:inline;">
                                        <input type="hidden" name="propertyId" value="@prop.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline btn-outline-primary" style="background: white;" title="Gửi lại cho admin duyệt sau khi đã chỉnh sửa">
                                            Gửi lại duyệt
                                        </button>
                                    </form>
                                }
                                <button class="btn btn-ghost btn-sm btn-icon" title="Xem chi tiết" onclick="openDetailModal(@propJson)"><i data-feather="eye" style="width: 14px; height: 14px;"></i></button>
                                @if (prop.Status.ToString() != "Blocked")
                                {
                                    <button class="btn btn-secondary btn-sm btn-icon" title="Chỉnh sửa" onclick="openEditModal(@propJson)"><i data-feather="edit-2" style="width: 14px; height: 14px;"></i></button>
                                    <button class="btn btn-primary btn-sm btn-icon" title="Hình ảnh" onclick="openUploadModal(@prop.Id)"><i data-feather="image" style="width: 14px; height: 14px;"></i></button>
                                }
                            </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-icon">🏠</div>
            <p>Bạn chưa có bất động sản nào. Bấm "Thêm BDS mới" để bắt đầu.</p>
        </div>
    }
</div>

<!-- Create Property Modal -->
<div class="modal-overlay" id="createModal" style="display: none;" onclick="closeModals()">
    <div class="modal-create-property" onclick="event.stopPropagation()">
        <form method="post" asp-page-handler="Create" style="display: flex; flex-direction: column; height: 100%;">
            <div class="modal-header">
                <span class="modal-title">Đăng tin BDS mới</span>
                <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" style="border: none;" onclick="closeModals()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group-with-icon">
                    <label class="form-label">Tiêu đề <span class="text-red">*</span></label>
                    <div class="input-icon-wrapper">
                        <i data-feather="file-text" class="input-icon" style="width: 16px;"></i>
                        <input type="text" asp-for="CreateForm.Title" class="form-control-with-icon" required placeholder="VD: Căn hộ 2PN Vinhomes..." />
                    </div>
                </div>

                <div class="form-group-with-icon">
                    <label class="form-label">Loại BDS <span class="text-red">*</span></label>
                    <div class="input-icon-wrapper">
                        <i data-feather="box" class="input-icon" style="width: 16px;"></i>
                        <select asp-for="CreateForm.PropertyType" class="form-control-with-icon" required>
                            <option value="Apartment">Căn hộ</option>
                            <option value="House">Nhà phố</option>
                            <option value="Studio">Căn hộ studio</option>
                            <option value="Room">Phòng trọ</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Thành phố <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="CreateForm.City" class="form-control-with-icon" required placeholder="TP.HCM" />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Quận/Huyện <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="CreateForm.District" class="form-control-with-icon" required placeholder="Quận Bình Thạnh" />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Phường/Xã</label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="CreateForm.Ward" class="form-control-with-icon" placeholder="Phường 12" />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Địa chỉ <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="CreateForm.Address" class="form-control-with-icon" required placeholder="Số nhà, tên đường..." />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Diện tích (m²) <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="maximize-2" class="input-icon" style="width: 16px;"></i>
                            <input type="number" step="0.01" asp-for="CreateForm.Area" class="form-control-with-icon" required placeholder="80" />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Số tầng</label>
                        <div class="input-icon-wrapper">
                            <i data-feather="layers" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="CreateForm.Floors" class="form-control-with-icon" placeholder="1" />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Phòng ngủ <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="home" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="CreateForm.Bedrooms" class="form-control-with-icon" required placeholder="2" />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Phòng tắm <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="droplet" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="CreateForm.Bathrooms" class="form-control-with-icon" required placeholder="2" />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Tiền thuê/tháng (VND) <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="dollar-sign" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="CreateForm.MonthlyRent" class="form-control-with-icon" required placeholder="15000000" />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Tiền đặt cọc (VND) <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="dollar-sign" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="CreateForm.DepositAmount" class="form-control-with-icon" required placeholder="30000000" />
                        </div>
                    </div>
                </div>

                <div class="form-group-with-icon">
                    <label class="form-label">Mô tả</label>
                    <div class="input-icon-wrapper">
                        <i data-feather="file-text" class="input-icon textarea-icon" style="width: 16px;"></i>
                        <textarea asp-for="CreateForm.Description" class="form-control-with-icon" rows="3" placeholder="Mô tả chi tiết về BDS..."></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tiện ích (phân cách bởi dấu phẩy)</label>
                    <textarea asp-for="CreateForm.Amenities" class="form-control" rows="2" placeholder="VD: Wifi, Điều hoà, Thang máy, Bãi xe..."></textarea>
                </div>

                <div class="form-checkboxes" style="display: flex; gap: 20px; align-items: center;">
                    <label class="custom-checkbox">
                        <input type="checkbox" asp-for="CreateForm.AllowPets" value="true" />
                        <span class="custom-checkbox-box">
                            <svg class="custom-checkbox-check" viewBox="0 0 12 10" fill="none">
                                <path d="M1 5L4.5 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <span class="custom-checkbox-content">
                            <i data-feather="smile" style="width: 16px;"></i>
                            <span>Được nuôi thú cưng</span>
                        </span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" asp-for="CreateForm.AllowSmoking" value="true" />
                        <span class="custom-checkbox-box">
                            <svg class="custom-checkbox-check" viewBox="0 0 12 10" fill="none">
                                <path d="M1 5L4.5 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <span class="custom-checkbox-content">
                            <i data-feather="wind" style="width: 16px;"></i>
                            <span>Được hút thuốc</span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Huỷ</button>
                <button type="submit" class="btn btn-primary">Đăng tin</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Property Modal -->
<div class="modal-overlay" id="editModal" style="display: none;" onclick="closeModals()">
    <div class="modal-create-property" onclick="event.stopPropagation()">
        <form method="post" asp-page-handler="Edit" id="editForm" style="display: flex; flex-direction: column; height: 100%;">
            <div class="modal-header">
                <span class="modal-title">Chỉnh sửa BDS</span>
                <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" style="border: none;" onclick="closeModals()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group-with-icon">
                    <label class="form-label">Tiêu đề <span class="text-red">*</span></label>
                    <div class="input-icon-wrapper">
                        <i data-feather="file-text" class="input-icon" style="width: 16px;"></i>
                        <input type="text" asp-for="EditForm.Title" id="editTitle" class="form-control-with-icon" required />
                    </div>
                </div>
                
                <div class="form-group-with-icon">
                    <label class="form-label">Loại BDS <span class="text-red">*</span></label>
                    <div class="input-icon-wrapper">
                        <i data-feather="box" class="input-icon" style="width: 16px;"></i>
                        <select asp-for="EditForm.PropertyType" id="editPropertyType" class="form-control-with-icon" required>
                            <option value="Apartment">Căn hộ</option>
                            <option value="House">Nhà phố</option>
                            <option value="Studio">Căn hộ studio</option>
                            <option value="Room">Phòng trọ</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Thành phố <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="EditForm.City" id="editCity" class="form-control-with-icon" required />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Quận/Huyện <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="EditForm.District" id="editDistrict" class="form-control-with-icon" required />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Phường/Xã</label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="EditForm.Ward" id="editWard" class="form-control-with-icon" />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Địa chỉ <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="map-pin" class="input-icon" style="width: 16px;"></i>
                            <input type="text" asp-for="EditForm.Address" id="editAddress" class="form-control-with-icon" required />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Diện tích (m²) <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="maximize-2" class="input-icon" style="width: 16px;"></i>
                            <input type="number" step="0.01" asp-for="EditForm.Area" id="editArea" class="form-control-with-icon" required />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Số tầng</label>
                        <div class="input-icon-wrapper">
                            <i data-feather="layers" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="EditForm.Floors" id="editFloors" class="form-control-with-icon" />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Phòng ngủ <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="home" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="EditForm.Bedrooms" id="editBedrooms" class="form-control-with-icon" required />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Phòng tắm <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="droplet" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="EditForm.Bathrooms" id="editBathrooms" class="form-control-with-icon" required />
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-with-icon">
                        <label class="form-label">Tiền thuê/tháng (VND) <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="dollar-sign" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="EditForm.MonthlyRent" id="editRent" class="form-control-with-icon" required />
                        </div>
                    </div>
                    <div class="form-group-with-icon">
                        <label class="form-label">Tiền đặt cọc (VND) <span class="text-red">*</span></label>
                        <div class="input-icon-wrapper">
                            <i data-feather="dollar-sign" class="input-icon" style="width: 16px;"></i>
                            <input type="number" asp-for="EditForm.DepositAmount" id="editDeposit" class="form-control-with-icon" required />
                        </div>
                    </div>
                </div>

                <div class="form-group-with-icon">
                    <label class="form-label">Mô tả</label>
                    <div class="input-icon-wrapper">
                        <i data-feather="file-text" class="input-icon textarea-icon" style="width: 16px;"></i>
                        <textarea asp-for="EditForm.Description" id="editDesc" class="form-control-with-icon" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tiện ích (phân cách bởi dấu phẩy)</label>
                    <textarea asp-for="EditForm.Amenities" id="editAmenities" class="form-control" rows="2"></textarea>
                </div>

                <div class="form-checkboxes" style="display: flex; gap: 20px; align-items: center;">
                    <label class="custom-checkbox">
                        <input type="checkbox" asp-for="EditForm.AllowPets" value="true" id="editAllowPets" />
                        <span class="custom-checkbox-box">
                            <svg class="custom-checkbox-check" viewBox="0 0 12 10" fill="none">
                                <path d="M1 5L4.5 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <span class="custom-checkbox-content">
                            <i data-feather="smile" style="width: 16px;"></i>
                            <span>Được nuôi thú cưng</span>
                        </span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" asp-for="EditForm.AllowSmoking" value="true" id="editAllowSmoking" />
                        <span class="custom-checkbox-box">
                            <svg class="custom-checkbox-check" viewBox="0 0 12 10" fill="none">
                                <path d="M1 5L4.5 8.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <span class="custom-checkbox-content">
                            <i data-feather="wind" style="width: 16px;"></i>
                            <span>Được hút thuốc</span>
                        </span>
                    </label>
                </div>
                <div style="margin-top: 12px; font-size: 12px; color: var(--danger);">
                    * Lưu ý: Nếu BDS đang có Hợp đồng Thuê hiện tại, chỉ có thể sửa Mô tả và Tiện ích. Khi sửa các trường khác và lưu thành công, BDS sẽ chuyển về trạng thái Chờ duyệt.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Huỷ</button>
                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal-overlay" id="detailModal" style="display: none;" onclick="closeModals()">
    <div class="modal" style="max-width: 800px; padding: 0;" onclick="event.stopPropagation()">
        <button type="button" class="btn btn-ghost btn-icon" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onclick="closeModals()"><i data-feather="x"></i></button>

        <div class="modal-body" style="max-height: 90vh; overflow-y: auto; padding: 24px;">
            <div class="image-slider" id="detailImageSlider" style="display: none; margin-top: 10px;">
                <!-- Images will be injected here via JS -->
            </div>

            <div class="dt-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h2 class="dt-title" id="dtTitle"></h2>
                        <div class="dt-address">
                            <i data-feather="map-pin" style="width: 16px;"></i>
                            <span id="dtFullAddress"></span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span class="badge badge-gray" id="detailStatus" style="font-size: 14px; padding: 6px 12px; margin-bottom: 8px; display: inline-block;"></span>
                        <div style="font-size: 12px; color: var(--text-muted);" id="detailCreatedAt"></div>
                    </div>
                </div>
            </div>

            <div class="dt-price-box">
                <div class="dt-price-main" id="dtRentMain"></div>
                <div class="dt-price-label">/ tháng</div>
            </div>

            <div class="dt-specs">
                <div class="spec-box">
                    <div class="spec-icon"><i data-feather="maximize-2" style="width: 24px; height: 24px;"></i></div>
                    <div class="spec-label">Diện tích</div>
                    <div class="spec-value" id="dtArea"></div>
                </div>
                <div class="spec-box">
                    <div class="spec-icon"><i data-feather="home" style="width: 24px; height: 24px;"></i></div>
                    <div class="spec-label">Phòng ngủ</div>
                    <div class="spec-value" id="dtBedrooms"></div>
                </div>
                <div class="spec-box">
                    <div class="spec-icon"><i data-feather="droplet" style="width: 24px; height: 24px;"></i></div>
                    <div class="spec-label">Phòng tắm</div>
                    <div class="spec-value" id="dtBathrooms"></div>
                </div>
            </div>

            <div class="dt-section">
                <h3 class="section-title">Mô tả</h3>
                <div class="section-content" id="dtDesc"></div>
            </div>

            <div class="dt-section">
                <h3 class="section-title">Thông tin chi tiết</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label"><i data-feather="tag" style="width: 16px;"></i> Loại BDS:</span>
                        <span class="detail-value" id="dtPropertyType"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i data-feather="layers" style="width: 16px;"></i> Số tầng:</span>
                        <span class="detail-value" id="dtFloors"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i data-feather="dollar-sign" style="width: 16px;"></i> Tiền cọc:</span>
                        <span class="detail-value" id="dtDeposit"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i data-feather="smile" style="width: 16px;"></i> Thú cưng:</span>
                        <span class="detail-value" id="dtAllowPets"></span>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <span class="detail-label"><i data-feather="wind" style="width: 16px;"></i> Hút thuốc:</span>
                        <span class="detail-value" id="dtAllowSmoking"></span>
                    </div>
                </div>
            </div>

            <div class="dt-section" id="dtAmenitiesSection" style="display: none;">
                <h3 class="section-title">Tiện ích</h3>
                <div class="amenities-list" id="dtAmenitiesList">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                 <button type="button" class="btn btn-secondary" onclick="closeModals()">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Image Modal -->
<div class="modal-overlay" id="uploadImageModal" style="display: none;" onclick="closeModals()">
    <div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title">Tải ảnh lên BDS</span>
            <button type="button" class="modal-close" onclick="closeModals()"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body" style="padding-bottom: 0;">
            <div id="existingImagesContainer" style="display: none;">
                <label class="form-label" style="margin-bottom: 8px;">Hình ảnh hiện tại</label>
                <div class="existing-images" id="existingImagesList">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 0;" />
        <form method="post" asp-page-handler="UploadImages" enctype="multipart/form-data">
            <input type="hidden" name="propertyId" id="uploadPropertyId" />
            <div class="modal-body" style="padding-top: 20px;">
                <div class="form-group">
                    <label class="form-label">Chọn ảnh (Hỗ trợ chọn nhiều)</label>
                    <input type="file" asp-for="UploadImages" multiple accept="image/*" class="form-control" style="padding: 10px; border: 1px dashed var(--border);" required />
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                        * Vui lòng chọn các file .jpg, .png. Ảnh sẽ được upload và bảo lưu an toàn.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Huỷ</button>
                <button type="submit" class="btn btn-primary">Bắt đầu Upload</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function closeModals() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('uploadImageModal').style.display = 'none';
        }

        function openUploadModal(propertyId) {
            document.getElementById('uploadPropertyId').value = propertyId;
            document.getElementById('uploadImageModal').style.display = 'flex';
            
            const container = document.getElementById('existingImagesContainer');
            const list = document.getElementById('existingImagesList');
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; font-size: 13px;">Đang tải ảnh...</div>';
            container.style.display = 'block';

            fetch(`?handler=PropertyDetails&id=${propertyId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.Images && data.Images.length > 0) {
                        list.innerHTML = data.Images.map(img => `
                            <div class="existing-img-card">
                                ${img.IsPrimary ? '<span class="primary-badge">Đại diện</span>' : ''}
                                <img src="${img.ImageUrl}" alt="Property Image" />
                                <div class="img-actions">
                                    ${!img.IsPrimary ? 
                                        `<form method="post" action="?handler=SetPrimaryImage" style="display:inline;">
                                            <input type="hidden" name="__RequestVerificationToken" value="${token}" />
                                            <input type="hidden" name="propertyId" value="${propertyId}" />
                                            <input type="hidden" name="imageId" value="${img.Id}" />
                                            <button type="submit" class="btn btn-sm btn-ghost" style="font-size: 11px; padding: 2px 6px;">Đặt làm ảnh chính</button>
                                        </form>` 
                                        : '<span style="font-size: 11px; color: var(--success); font-weight: bold;">Ảnh chính</span>'
                                    }
                                </div>
                            </div>
                        `).join('');
                    } else {
                        list.innerHTML = '<div style="grid-column: 1/-1; font-size: 13px; color: var(--text-muted);">Chưa có hình ảnh nào.</div>';
                    }
                })
                .catch(err => {
                    console.error('Error fetching images:', err);
                    list.innerHTML = '<div style="grid-column: 1/-1; font-size: 13px; color: var(--danger);">Lỗi tải ảnh.</div>';
                });
        }

        function openCreateModal() {
            closeModals();
            document.getElementById('createModal').style.display = 'flex';
        }

        function openEditModal(prop) {
            closeModals();
            
            // Set form action target to include the ID
            document.getElementById('editForm').action = `?handler=Edit&id=${prop.Id}`;
            
            // Populate form fields
            document.getElementById('editTitle').value = prop.Title || '';
            let typeVal = prop.PropertyType === 1 ? 'Apartment' : 
                          prop.PropertyType === 2 ? 'House' : 
                          prop.PropertyType === 3 ? 'Studio' : 
                          prop.PropertyType === 4 ? 'Room' : 'Apartment';
            document.getElementById('editPropertyType').value = prop.PropertyTypeText || typeVal;
            document.getElementById('editDesc').value = prop.Description || '';
            document.getElementById('editCity').value = prop.City || '';
            document.getElementById('editAddress').value = prop.Address || '';
            document.getElementById('editDistrict').value = prop.District || '';
            document.getElementById('editWard').value = prop.Ward || '';
            document.getElementById('editArea').value = prop.Area || '';
            document.getElementById('editFloors').value = prop.Floors || '';
            document.getElementById('editBedrooms').value = prop.Bedrooms || '';
            document.getElementById('editBathrooms').value = prop.Bathrooms || '';
            document.getElementById('editRent').value = prop.MonthlyRent || 0;
            document.getElementById('editDeposit').value = prop.DepositAmount || 0;
            document.getElementById('editAmenities').value = prop.Amenities || '';
            document.getElementById('editAllowPets').checked = prop.AllowPets || false;
            document.getElementById('editAllowSmoking').checked = prop.AllowSmoking || false;
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function openDetailModal(prop) {
            closeModals();
            
            const slider = document.getElementById('detailImageSlider');
            slider.style.display = 'flex';
            slider.innerHTML = '<div style="padding: 20px; text-align: center; width: 100%; font-size: 14px;">Đang tải ảnh...</div>';
            
            fetch(`?handler=PropertyDetails&id=${prop.Id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.Images && data.Images.length > 0) {
                        const sortedImages = [...data.Images].sort((a,b) => (b.IsPrimary === true ? 1 : 0) - (a.IsPrimary === true ? 1 : 0));
                        slider.innerHTML = sortedImages.map(img => `<img src="${img.ImageUrl}" alt="Property Image" />`).join('');
                    } else if (prop.ThumbnailUrl) {
                        slider.innerHTML = `<img src="${prop.ThumbnailUrl}" alt="Thumbnail" />`;
                    } else {
                        slider.innerHTML = '<div style="padding: 20px; text-align: center; width: 100%; color: var(--text-muted); background: var(--bg-card); border: 1px dashed var(--border); border-radius: 12px; height: 150px; display: flex; align-items: center; justify-content: center;">Chưa có hình ảnh nào.</div>';
                        slider.style.height = '150px';
                    }
                })
                .catch(err => {
                    console.error(err);
                    if (prop.ThumbnailUrl) {
                        slider.innerHTML = `<img src="${prop.ThumbnailUrl}" alt="Thumbnail" />`;
                    } else {
                        slider.style.display = 'none';
                    }
                });

            let statusText = prop.Status === 'Approved' ? 'Còn trống' :
                             prop.Status === 'Rented' ? 'Đã thuê' :
                             prop.Status === 'Pending' ? 'Chờ duyệt' :
                             prop.Status === 'Draft' ? 'Bản nháp' :
                             prop.Status === 'Rejected' ? 'Từ chối' :
                             prop.Status === 'Blocked' ? 'Bị khóa' : String(prop.Status);
            
            let statusClass = prop.Status === 'Approved' ? 'badge-success' :
                              prop.Status === 'Rented' ? 'badge-info' :
                              prop.Status === 'Pending' ? 'badge-warning' :
                              prop.Status === 'Rejected' ? 'badge-danger' : 
                              prop.Status === 'Blocked' ? '' : 'badge-gray';

            const statusEl = document.getElementById('detailStatus');
            statusEl.textContent = statusText;
            statusEl.className = `badge ${statusClass}`;
            if(prop.Status === 'Blocked') {
                statusEl.style.background = 'rgba(52, 58, 64, 0.1)';
                statusEl.style.color = '#343a40';
                statusEl.style.border = '1px solid #343a40';
            } else {
                statusEl.style.background = '';
                statusEl.style.color = '';
                statusEl.style.border = '';
            }

            document.getElementById('detailCreatedAt').textContent = 'Ngày đăng: ' + new Date(prop.CreatedAt).toLocaleDateString('vi-VN');
            
            // Text Content assignments
            document.getElementById('dtTitle').textContent = prop.Title || 'Chưa có tiêu đề';
            document.getElementById('dtFullAddress').textContent = `${prop.Address}, ${prop.Ward}, ${prop.District}, ${prop.City}`;
            document.getElementById('dtRentMain').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(prop.MonthlyRent);
            
            let typeText = prop.PropertyType === 1 ? 'Căn hộ' : 
                           prop.PropertyType === 2 ? 'Nhà phố' : 
                           prop.PropertyType === 3 ? 'Căn hộ studio' : 
                           prop.PropertyType === 4 ? 'Phòng trọ' : String(prop.PropertyType);
            
            document.getElementById('dtArea').textContent = `${prop.Area} m²`;
            document.getElementById('dtBedrooms').textContent = prop.Bedrooms || 0;
            document.getElementById('dtBathrooms').textContent = prop.Bathrooms || 0;
            document.getElementById('dtDesc').textContent = prop.Description || 'Không có mô tả';
            
            document.getElementById('dtPropertyType').textContent = prop.PropertyTypeText || typeText;
            document.getElementById('dtFloors').textContent = prop.Floors || 'N/A';
            document.getElementById('dtDeposit').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(prop.DepositAmount);
            
            document.getElementById('dtAllowPets').textContent = prop.AllowPets ? "✅ Cho phép" : "❌ Không";
            document.getElementById('dtAllowSmoking').textContent = prop.AllowSmoking ? "✅ Cho phép" : "❌ Không";
            
            const amenitiesSection = document.getElementById('dtAmenitiesSection');
            const amenitiesList = document.getElementById('dtAmenitiesList');
            if (prop.Amenities) {
                amenitiesSection.style.display = 'block';
                const list = prop.Amenities.split(',').map(a => a.trim()).filter(a => a);
                amenitiesList.innerHTML = list.map(a => `<span class="amenity-badge"><i data-feather="check" style="width: 14px;"></i> ${a}</span>`).join('');
                if(window.feather) feather.replace();
            } else {
                amenitiesSection.style.display = 'none';
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function setFilter(status) {
            document.getElementById('statusFilter').value = status;
            document.getElementById('filterForm').submit();
        }
    </script>
}
