@page
@model PropertyManagementSystemVer2.Web.Pages.Landlord.PaymentsModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Thanh to√°n";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-16" style="padding: 12px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 8px; border: 1px solid #10b981;">
        <i data-feather="check-circle" style="width:15px;"></i> @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-16" style="padding: 12px 16px; background: rgba(239,68,68,0.1); color: #ef4444; border-radius: 8px; border: 1px solid #ef4444;">
        <i data-feather="alert-circle" style="width:15px;"></i> @TempData["ErrorMessage"]
    </div>
}

<div class="mb-20">
    <div class="page-title">Qu·∫£n l√Ω Thanh to√°n</div>
    <div class="page-desc">Theo d√µi v√† x√°c nh·∫≠n c√°c kho·∫£n thu ti·ªÅn thu√™</div>
</div>

@{
    var pendingConfirm = Model.Payments.Count(p => p.Status.ToString() == "Pending" && !string.IsNullOrEmpty(p.PaymentProof));
    var overdue = Model.Payments.Count(p => p.Status.ToString() == "Overdue");
    var completed = Model.Payments.Count(p => p.Status.ToString() == "Completed");
    var totalRevenue = Model.Payments.Where(p => p.Status.ToString() == "Completed").Sum(p => p.Amount);
}

<div class="stat-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
    <div class="stat-card">
        <div class="stat-icon yellow"><i data-feather="clock"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ch·ªù x√°c nh·∫≠n</div>
            <div class="stat-value">@pendingConfirm</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red"><i data-feather="alert-triangle"></i></div>
        <div class="stat-info">
            <div class="stat-label">Qu√° h·∫°n</div>
            <div class="stat-value">@overdue</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i data-feather="check-circle"></i></div>
        <div class="stat-info">
            <div class="stat-label">ƒê√£ thu</div>
            <div class="stat-value">@completed</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue"><i data-feather="trending-up"></i></div>
        <div class="stat-info">
            <div class="stat-label">T·ªïng ƒë√£ thu (VNƒê)</div>
            <div class="stat-value" style="font-size: 18px;">@totalRevenue.ToString("N0")</div>
        </div>
    </div>
</div>

<form method="get" class="filter-bar mb-20" id="filterForm">
    <div class="admin-search-wrapper" style="flex: 1; max-width: 300px;">
        <i data-feather="search" class="admin-search-icon"></i>
        <input name="SearchTerm" class="admin-search-input" value="@Model.SearchTerm" placeholder="T√¨m t√™n ng∆∞·ªùi thu√™, m√£ Hƒê..." onchange="this.form.submit()" />
        <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" id="StatusFilterInput" />
    </div>
    <div style="display: flex; gap: 8px;">
        <button type="button" class="btn @(Model.StatusFilter == "All" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('All')">T·∫•t c·∫£</button>
        <button type="button" class="btn @(Model.StatusFilter == "Pending" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Pending')">Ch·ªù</button>
        <button type="button" class="btn @(Model.StatusFilter == "Completed" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Completed')">ƒê√£ thu</button>
        <button type="button" class="btn @(Model.StatusFilter == "Overdue" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Overdue')">Qu√° h·∫°n</button>
    </div>
</form>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>H√≥a ƒë∆°n</th>
                    <th>Ng∆∞·ªùi thu√™</th>
                    <th>BƒêS</th>
                    <th>H·∫°n ch√≥t</th>
                    <th>S·ªë ti·ªÅn</th>
                    <th>Bi√™n lai</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.FilteredPayments.Any())
                {
                    foreach (var p in Model.FilteredPayments)
                    {
                        var isOverdue = p.DueDate < DateTime.Now && p.Status.ToString() == "Pending";
                        var hasProof = !string.IsNullOrEmpty(p.PaymentProof);
                        var canConfirm = p.Status.ToString() == "Pending" && hasProof;

                        <tr>
                            <td>
                                <div class="fw-700">#@p.Id</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Hƒê: @p.LeaseNumber</div>
                            </td>
                            <td style="color: var(--text-secondary);">@p.TenantName</td>
                            <td>
                                <div style="font-size: 13px; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@p.PropertyTitle</div>
                                <div style="font-size: 11px; color: var(--text-muted);">@p.BillingMonth/@p.BillingYear</div>
                            </td>
                            <td style="color: @(isOverdue ? "var(--danger)" : "var(--text-secondary)"); font-weight: @(isOverdue ? "700" : "400");">
                                @p.DueDate.ToString("dd/MM/yyyy")
                            </td>
                            <td style="color: var(--success); font-weight: 700;">@p.Amount.ToString("N0")ƒë</td>
                            <td>
                                @if (hasProof)
                                {
                                    <a href="@p.PaymentProof" target="_blank" class="btn btn-ghost btn-sm btn-icon" title="Xem bi√™n lai">
                                        <i data-feather="image" style="width: 14px;"></i>
                                    </a>
                                }
                                else
                                {
                                    <span style="color: var(--text-muted); font-size: 12px;">‚Äî</span>
                                }
                            </td>
                            <td>
                                @if (p.Status.ToString() == "Pending" && hasProof)
                                {
                                    <span class="badge badge-warning" style="animation: pulse 2s infinite;">Ch·ªù x√°c nh·∫≠n</span>
                                }
                                else if (p.Status.ToString() == "Pending")
                                {
                                    <span class="badge badge-warning">Ch·ªù thanh to√°n</span>
                                }
                                else if (p.Status.ToString() == "Overdue")
                                {
                                    <span class="badge badge-danger">Qu√° h·∫°n</span>
                                }
                                else if (p.Status.ToString() == "Completed")
                                {
                                    <span class="badge badge-success">ƒê√£ thu ‚úì</span>
                                }
                                else if (p.Status.ToString() == "Failed")
                                {
                                    <span class="badge badge-danger">T·ª´ ch·ªëi</span>
                                }
                                else
                                {
                                    <span class="badge" style="background: rgba(148,163,184,0.15); color: var(--text-muted);">@p.Status</span>
                                }
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px;">
                                    <button class="btn btn-ghost btn-sm btn-icon" title="Xem chi ti·∫øt" onclick="openDetail(@p.Id)">
                                        <i data-feather="eye" style="width: 14px;"></i>
                                    </button>
                                    @if (canConfirm)
                                    {
                                        <button class="btn btn-success btn-sm btn-icon" title="X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn"
                                                onclick="confirmPayment(@p.Id, true, '@p.TenantName')">
                                            <i data-feather="check" style="width: 14px;"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm btn-icon" title="T·ª´ ch·ªëi"
                                                onclick="rejectPayment(@p.Id)">
                                            <i data-feather="x" style="width: 14px;"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon" style="font-size: 32px;">üí≥</div>
                                <p style="color: var(--text-muted); margin-top: 12px;">Kh√¥ng c√≥ h√≥a ƒë∆°n ph√π h·ª£p.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div style="padding: 12px 16px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-muted);">
        Hi·ªÉn th·ªã @Model.FilteredPayments.Count / @Model.Payments.Count h√≥a ƒë∆°n
    </div>
</div>

<!-- Payment data store -->
<script>
    window._lp = {};
    @foreach (var p in Model.FilteredPayments)
    {
        <text>
    window._lp[@p.Id] = {
        id: @p.Id,
        description: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.Description ?? "")),
        tenantName: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.TenantName ?? "")),
        amount: "@p.Amount.ToString("N0")",
        dueDate: "@p.DueDate.ToString("dd/MM/yyyy")",
        paidDate: "@(p.PaidDate.HasValue ? p.PaidDate.Value.ToString("dd/MM/yyyy HH:mm") : "")",
        paymentProof: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.PaymentProof ?? "")),
        transactionId: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.TransactionId ?? "")),
        notes: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.Notes ?? "")),
        paymentMethod: "@(p.PaymentMethod.HasValue ? p.PaymentMethod.Value.ToString() : "")"
    };
        </text>
    }
</script>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal" style="display: none;" onclick="this.style.display='none'">
    <div class="modal" style="max-width: 520px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title">Chi ti·∫øt thanh to√°n</span>
            <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="document.getElementById('detailModal').style.display='none'">‚úï</button>
        </div>
        <div class="modal-body">
            <div style="display: grid; gap: 10px; font-size: 13px;">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">N·ªôi dung</span>
                    <span id="d_desc" style="font-weight: 600; max-width: 260px; text-align: right;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">Ng∆∞·ªùi thu√™</span>
                    <span id="d_tenant" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">S·ªë ti·ªÅn</span>
                    <span id="d_amount" style="font-weight: 800; color: var(--success); font-size: 15px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">Ph∆∞∆°ng th·ª©c</span>
                    <span id="d_method" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">M√£ giao d·ªãch</span>
                    <span id="d_txid" style="font-weight: 600; font-family: monospace;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">H·∫°n ch√≥t</span>
                    <span id="d_due" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary);">Ng√†y thanh to√°n</span>
                    <span id="d_paid" style="font-weight: 600;"></span>
                </div>
            </div>
            <div id="d_proof_wrap" style="margin-top: 16px; display: none;">
                <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">üìé Bi√™n lai thanh to√°n</div>
                <a id="d_proof_link" href="#" target="_blank">
                    <img id="d_proof_img" src="" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border);" />
                </a>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('detailModal').style.display='none'">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Hidden confirm form -->
<form id="confirmForm" method="post" asp-page-handler="ConfirmPayment" style="display:none;">
    <input type="hidden" name="paymentId" id="cf_paymentId" />
    <input type="hidden" name="isConfirmed" id="cf_isConfirmed" />
    <input type="hidden" name="notes" id="cf_notes" />
    <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
</form>

@section Scripts {
<style>
@@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
.admin-search-wrapper { position: relative; display: flex; align-items: center; }
.admin-search-icon { position: absolute; left: 10px; width: 14px; color: var(--text-muted); pointer-events: none; }
.admin-search-input { width: 100%; padding: 8px 12px 8px 32px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 13px; }
.admin-search-input:focus { outline: none; border-color: var(--accent); }
</style>
<script>
    function setFilter(status) {
        document.getElementById('StatusFilterInput').value = status;
        document.getElementById('filterForm').submit();
    }

    function openDetail(id) {
        const p = window._lp[id];
        if (!p) return;
        document.getElementById('d_desc').innerText = p.description;
        document.getElementById('d_tenant').innerText = p.tenantName;
        document.getElementById('d_amount').innerText = p.amount + 'ƒë';
        const methodMap = { BankTransfer: 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng', Cash: 'Ti·ªÅn m·∫∑t', CreditCard: 'Th·∫ª t√≠n d·ª•ng', EWallet: 'V√≠ ƒëi·ªán t·ª≠' };
        document.getElementById('d_method').innerText = methodMap[p.paymentMethod] || p.paymentMethod || '‚Äî';
        document.getElementById('d_txid').innerText = p.transactionId || '‚Äî';
        document.getElementById('d_due').innerText = p.dueDate;
        document.getElementById('d_paid').innerText = p.paidDate || 'Ch∆∞a thanh to√°n';
        const proofWrap = document.getElementById('d_proof_wrap');
        if (p.paymentProof) {
            proofWrap.style.display = 'block';
            document.getElementById('d_proof_img').src = p.paymentProof;
            document.getElementById('d_proof_link').href = p.paymentProof;
        } else {
            proofWrap.style.display = 'none';
        }
        document.getElementById('detailModal').style.display = 'flex';
    }

    function confirmPayment(id, confirmed, tenantName) {
        Swal.fire({
            title: 'X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn?',
            html: `B·∫°n x√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn thu√™ t·ª´ <strong>${tenantName}</strong>?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'ƒê√£ nh·∫≠n ‚úì',
            cancelButtonText: 'H·ªßy',
            input: 'text',
            inputPlaceholder: 'Ghi ch√∫ (tu·ª≥ ch·ªçn)...',
        }).then(result => {
            if (result.isConfirmed) {
                document.getElementById('cf_paymentId').value = id;
                document.getElementById('cf_isConfirmed').value = 'true';
                document.getElementById('cf_notes').value = result.value || '';
                document.getElementById('confirmForm').submit();
            }
        });
    }

    function rejectPayment(id) {
        Swal.fire({
            title: 'T·ª´ ch·ªëi thanh to√°n?',
            text: 'H√£y nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë·ªÉ th√¥ng b√°o cho ng∆∞·ªùi thu√™.',
            icon: 'warning',
            input: 'text',
            inputPlaceholder: 'L√Ω do t·ª´ ch·ªëi...',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'T·ª´ ch·ªëi',
            cancelButtonText: 'H·ªßy',
            inputValidator: (value) => {
                if (!value) return 'Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!';
            }
        }).then(result => {
            if (result.isConfirmed) {
                document.getElementById('cf_paymentId').value = id;
                document.getElementById('cf_isConfirmed').value = 'false';
                document.getElementById('cf_notes').value = result.value;
                document.getElementById('confirmForm').submit();
            }
        });
    }
</script>
}
