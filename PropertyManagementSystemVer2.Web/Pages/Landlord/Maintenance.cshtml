@page
@model PropertyManagementSystemVer2.Web.Pages.Landlord.MaintenanceModel
@{
    ViewData["Title"] = "Quản lý Bảo trì";
}

<div class="mb-20">
    <div class="page-title">Quản lý Yêu cầu Bảo trì</div>
    <div class="page-desc">Giải quyết các vấn đề sửa chữa từ người thuê</div>
</div>

<div class="card mb-16" style="padding: 16px;">
    <div class="admin-search-wrapper" style="margin: 0;">
        <i data-feather="search" class="admin-search-icon"></i>
        <input type="text" id="searchInput" class="admin-search-input" placeholder="Tìm theo tên yêu cầu, bất động sản..." onkeyup="filterRequests()" />
    </div>
</div>

<div class="filter-bar">
    <button class="btn btn-primary btn-sm filter-btn" data-status="All" onclick="setStatusFilter('All', this)">Tất cả</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="InProgress" onclick="setStatusFilter('InProgress', this)">Đang xử lý</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="Open" onclick="setStatusFilter('Open', this)">Đang chờ</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="Resolved" onclick="setStatusFilter('Resolved', this)">Đã xong</button>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>TIÊU ĐỀ / BẤT ĐỘNG SẢN</th>
                    <th>NGÀY YÊU CẦU</th>
                    <th>MỨC ĐỘ</th>
                    <th>DANH MỤC</th>
                    <th>TRẠNG THÁI</th>
                    <th>HÀNH ĐỘNG</th>
                </tr>
            </thead>
            <tbody id="maintenanceTableBody">
                @if (Model.MaintenanceRequests != null && Model.MaintenanceRequests.Any())
                {
                    foreach (var req in Model.MaintenanceRequests)
                    {
                        <tr class="maintenance-row" data-search="@req.Title.ToLower() @req.PropertyTitle.ToLower()" data-status="@req.Status">
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <strong style="font-size: 13px; color: var(--text-primary);">@req.Title</strong>
                                    <span style="font-size: 11px; color: var(--text-muted);">@req.PropertyTitle</span>
                                </div>
                            </td>
                            <td class="text-muted">@req.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                @if (req.Priority.ToString() == "Urgent" || req.Priority.ToString() == "Critical")
                                {
                                    <span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">Khẩn cấp</span>
                                }
                                else if (req.Priority.ToString() == "High")
                                {
                                    <span class="badge" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">Cao</span>
                                }
                                else if (req.Priority.ToString() == "Medium")
                                {
                                    <span class="badge badge-info">Trung bình</span>
                                }
                                else
                                {
                                    <span class="badge badge-success">Thấp</span>
                                }
                            </td>
                            <td>
                                @{
                                    var categoryLabel = req.Category.ToString() switch
                                    {
                                        "Plumbing" => "Ống nước",
                                        "Electrical" => "Điện",
                                        "Appliance" => "Gia dụng",
                                        "Structural" => "Cấu trúc/Xây dựng",
                                        "Other" => "Khác",
                                        _ => req.Category.ToString()
                                    };
                                }
                                <span class="badge badge-gray">@categoryLabel</span>
                            </td>
                            <td>
                                @if (req.Status.ToString() == "Open")
                                {
                                    <span class="badge badge-warning">Đang chờ</span>
                                }
                                else if (req.Status.ToString() == "InProgress")
                                {
                                    <span class="badge badge-info">Đang xử lý</span>
                                }
                                else if (req.Status.ToString() == "Resolved")
                                {
                                    <span class="badge badge-success">Đã xong</span>
                                }
                                else if (req.Status.ToString() == "Cancelled")
                                {
                                    <span class="badge badge-danger">Đã hủy</span>
                                }
                                else
                                {
                                    <span class="badge badge-gray">@req.Status</span>
                                }
                            </td>
                            <td>
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <button class="btn btn-ghost btn-sm btn-icon" onclick="openDetailModal(@req.Id)" title="Xem chi tiết" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                        <i data-feather="eye" style="width: 16px;"></i>
                                    </button>
                                    @if (req.Status.ToString() == "Open")
                                    {
                                        <button class="btn btn-ghost btn-sm btn-icon" onclick="openApproveModal(@req.Id, '@Html.Raw(req.Title.Replace("'", "\\'"))')" title="Đã kêu thợ" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; color: var(--success);">
                                            <i data-feather="user-check" style="width: 16px;"></i>
                                        </button>
                                        <button class="btn btn-ghost btn-sm btn-icon" onclick="openRejectModal(@req.Id, '@Html.Raw(req.Title.Replace("'", "\\'"))')" title="Từ chối" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; color: var(--danger);">
                                            <i data-feather="x-circle" style="width: 16px;"></i>
                                        </button>
                                    }
                                    @if (req.Status.ToString() == "InProgress")
                                    {
                                        <button class="btn btn-ghost btn-sm btn-icon" onclick="confirmComplete(@req.Id)" title="Hoàn thành" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; color: var(--success);">
                                            <i data-feather="check-circle" style="width: 16px;"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-icon">tool</div>
                                <p>Không có yêu cầu bảo trì nào cần xử lý hoặc bạn chưa có bất động sản nào.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (Model.MaintenanceRequests != null)
{
    foreach (var req in Model.MaintenanceRequests)
    {
        <!-- DETAIL MODAL -->
        <div id="detailModal-@req.Id" class="modal-overlay" style="display: none;">
            <div class="modal custom-modal" style="width: 600px;">
                <div class="modal-header">
                    <span class="modal-title">#@req.Id - @req.Title</span>
                    <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('detailModal-@req.Id')">✕</button>
                </div>
                <div class="modal-body" style="background-color: var(--bg-hover); padding: 20px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        @if (req.Status.ToString() == "Open")
                        {
                            <span class="badge badge-warning">Đang chờ</span>
                        }
                        else if (req.Status.ToString() == "InProgress")
                        {
                            <span class="badge badge-info">Đang xử lý</span>
                        }
                        else if (req.Status.ToString() == "Resolved")
                        {
                            <span class="badge badge-success">Đã xong</span>
                        }
                        else if (req.Status.ToString() == "Cancelled")
                        {
                            <span class="badge badge-danger">Đã hủy</span>
                        }
                        else
                        {
                            <span class="badge badge-gray">@req.Status</span>
                        }
                        @{
                            var badgeCategoryLabel = req.Category.ToString() switch
                            {
                                "Plumbing" => "Ống nước",
                                "Electrical" => "Điện",
                                "Appliance" => "Gia dụng",
                                "Structural" => "Cấu trúc/Xây dựng",
                                "Other" => "Khác",
                                _ => req.Category.ToString()
                            };
                        }
                        
                        <span class="badge badge-gray">@badgeCategoryLabel</span>
                    </div>
                    
                    <div style="background-color: var(--bg-card); border-radius: 8px; padding: 16px; border: 1px solid var(--border);">
                        <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">BDS</span>
                            <span class="info-value" style="font-weight: 500;">@req.PropertyTitle</span>
                        </div>
                        <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Người yêu cầu</span>
                            <span class="info-value" style="font-weight: 500;">@req.RequesterName</span>
                        </div>
                        <div class="info-row" style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Mô tả chi tiết</span>
                            <span class="info-value" style="white-space: pre-wrap; font-size: 14px;">@req.Description</span>
                        </div>
                        <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Ngày tạo</span>
                            <span class="info-value" style="font-weight: 500;">@req.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>

                        @if (!string.IsNullOrEmpty(req.Resolution))
                        {
                            <div class="info-row" style="display: flex; flex-direction: column; gap: 4px; border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 12px;">
                                <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Lịch sử / Phản hồi</span>
                                <span class="info-value" style="white-space: pre-wrap; font-size: 14px; color: var(--primary);">@req.Resolution</span>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(req.ImageUrls))
                        {
                            var images = req.ImageUrls.Split(',').Select(u => u.Trim()).Where(u => !string.IsNullOrEmpty(u)).ToArray();
                            if (images.Length > 0)
                            {
                            <div class="info-row" style="margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                                <span class="info-label" style="color: var(--text-muted); font-size: 13px; display: block; margin-bottom: 8px;"><i data-feather="image" style="width: 14px; margin-right: 4px;"></i>Hình ảnh minh họa (@images.Length ảnh)</span>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                                    @foreach (var img in images)
                                    {
                                        var trimmedImg = img.Trim();
                                        <div style="position: relative; border-radius: 6px; overflow: hidden; padding-top: 100%; border: 1px solid var(--border); background: var(--bg-hover);">
                                            <a href="@trimmedImg" target="_blank" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                                <img src="@trimmedImg" alt="Hình ảnh đính kèm"
                                                     style="width: 100%; height: 100%; object-fit: cover; transition: opacity 0.2s;"
                                                     onerror="this.onerror=null; this.src=''; this.style.display='none'; this.parentElement.parentElement.querySelector('.img-err').style.display='flex';" />
                                                <div class="img-err" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; color:var(--text-muted); font-size:11px; flex-direction:column; gap:4px;">
                                                    <i data-feather="image" style="width:20px;"></i>
                                                    <span>Lỗi tải ảnh</span>
                                                </div>
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                            }
                        }

                    </div>
                </div>
                <div class="modal-footer">
                    @if (req.Status.ToString() == "Open")
                    {
                        <button class="btn btn-danger" onclick="closeModal('detailModal-@req.Id'); openRejectModal(@req.Id, '@Html.Raw(req.Title.Replace("'", "\\'"))')">Từ chối</button>
                        <button class="btn btn-success" onclick="closeModal('detailModal-@req.Id'); openApproveModal(@req.Id, '@Html.Raw(req.Title.Replace("'", "\\'"))')">Đã kêu thợ</button>
                    }
                    @if (req.Status.ToString() == "InProgress")
                    {
                        <button class="btn btn-success" onclick="closeModal('detailModal-@req.Id'); confirmComplete(@req.Id)"><i data-feather="check-circle" style="width: 16px; margin-right: 4px;"></i> Hoàn thành</button>
                    }
                    <button class="btn btn-secondary" onclick="closeModal('detailModal-@req.Id')">Đóng</button>
                </div>
            </div>
        </div>
    }
}

<!-- ACTION MODALS (using forms) -->
<div id="approveModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <form method="post" asp-page-handler="Approve" id="approveForm">
            <div class="modal-header">
                <span class="modal-title">Phê duyệt yêu cầu bảo trì</span>
                <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('approveModal')">✕</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-primary); margin-bottom: 16px;">
                    Bạn đang phê duyệt yêu cầu: <strong id="approveRequestTitle"></strong>
                </p>
                <input type="hidden" name="requestId" id="approveRequestId" />
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Tên kỹ thuật viên / Thợ sửa *</label>
                    <input name="technicianName" class="form-control" placeholder="Nhập tên thợ..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;" />
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Số điện thoại thợ *</label>
                    <input name="technicianPhone" class="form-control" placeholder="Nhập số điện thoại..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Hủy</button>
                <button type="button" class="btn btn-success" onclick="confirmApprove()">✓ Phê duyệt</button>
            </div>
        </form>
    </div>
</div>

<div id="rejectModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <form method="post" asp-page-handler="Reject" id="rejectForm">
            <div class="modal-header">
                <span class="modal-title">Từ chối yêu cầu bảo trì</span>
                <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('rejectModal')">✕</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-primary); margin-bottom: 16px;">
                    Bạn đang từ chối yêu cầu: <strong id="rejectRequestTitle"></strong>
                </p>
                <input type="hidden" name="requestId" id="rejectRequestId" />
                <div class="form-group">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Lý do từ chối *</label>
                    <textarea name="reason" class="form-control" rows="4" placeholder="Nhập lý do từ chối yêu cầu này..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('rejectModal')">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">Từ chối</button>
            </div>
        </form>
    </div>
</div>

<form method="post" asp-page-handler="Complete" id="completeForm" style="display: none;">
    <input type="hidden" name="requestId" id="completeRequestId" />
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            @if(TempData["SuccessMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: '@Html.Raw(TempData["SuccessMessage"])',
                    confirmButtonColor: '#3085d6'
                });
                </text>
            }
            @if(TempData["ErrorMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: '@Html.Raw(TempData["ErrorMessage"])',
                    confirmButtonColor: '#d33'
                });
                </text>
            }
        });

        function filterRequests() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            var activeStatus = document.querySelector('.filter-btn.btn-primary').getAttribute('data-status');
            
            var rows = document.querySelectorAll('.maintenance-row');
            rows.forEach(function(row) {
                var text = row.getAttribute('data-search');
                var status = row.getAttribute('data-status');
                
                var matchSearch = search === "" || text.includes(search);
                var matchStatus = activeStatus === "All" || status === activeStatus;
                
                if (matchSearch && matchStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function setStatusFilter(status, btn) {
            document.querySelectorAll('.filter-btn').forEach(function(b) {
                b.classList.remove('btn-primary');
                b.classList.add('btn-ghost');
            });
            btn.classList.remove('btn-ghost');
            btn.classList.add('btn-primary');
            filterRequests();
        }

        function openDetailModal(id) {
            document.getElementById('detailModal-' + id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function openApproveModal(id, title) {
            document.getElementById('approveRequestId').value = id;
            document.getElementById('approveRequestTitle').textContent = title;
            document.getElementById('approveModal').style.display = 'flex';
        }

        function openRejectModal(id, title) {
            document.getElementById('rejectRequestId').value = id;
            document.getElementById('rejectRequestTitle').textContent = title;
            document.getElementById('rejectModal').style.display = 'flex';
        }


        
        function confirmApprove() {
            var form = document.getElementById('approveForm');
            if(form.reportValidity()) {
                Swal.fire({
                    title: 'Bạn có chắc chắn?',
                    text: "Sẽ phê duyệt và thay đổi trạng thái thành Đang xử lý",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            }
        }
        
        function confirmReject() {
            var form = document.getElementById('rejectForm');
            if(form.reportValidity()) {
                Swal.fire({
                    title: 'Xác nhận từ chối?',
                    text: "Yêu cầu này sẽ bị hủy bỏ vĩnh viễn",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Từ chối',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            }
        }
        
        function confirmComplete(id) {
            if (id) {
                document.getElementById('completeRequestId').value = id;
            }
            Swal.fire({
                title: 'Xác nhận hoàn thành?',
                text: "Đánh dấu yêu cầu này đã được giải quyết xong",
                icon: 'success',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Hoàn thành',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('completeForm').submit();
                }
            });
        }
    </script>
}
