@page
@model PropertyManagementSystemVer2.Web.Pages.Admin.PaymentsModel
@{
    ViewData["Title"] = "Giao d·ªãch h·ªá th·ªëng";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-16" style="padding: 12px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 8px; border: 1px solid #10b981;">
        <i data-feather="check-circle" style="width:15px;"></i> @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-16" style="padding: 12px 16px; background: rgba(239,68,68,0.1); color: #ef4444; border-radius: 8px; border: 1px solid #ef4444;">
        <i data-feather="alert-circle" style="width:15px;"></i> @TempData["ErrorMessage"]
    </div>
}

<div class="mb-20">
    <div class="page-title">Qu·∫£n l√Ω Giao d·ªãch</div>
    <div class="page-desc">Gi√°m s√°t t·∫•t c·∫£ c√°c kho·∫£n thanh to√°n trong h·ªá th·ªëng</div>
</div>

@{
    var completed = Model.Payments.Count(p => p.Status.ToString() == "Completed");
    var pending = Model.Payments.Count(p => p.Status.ToString() == "Pending");
    var overdue = Model.Payments.Count(p => p.Status.ToString() == "Overdue");
    var totalRevenue = Model.Payments.Where(p => p.Status.ToString() == "Completed").Sum(p => p.Amount);
}

<div class="stat-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
    <div class="stat-card">
        <div class="stat-icon blue"><i data-feather="layers"></i></div>
        <div class="stat-info">
            <div class="stat-label">T·ªïng giao d·ªãch</div>
            <div class="stat-value">@Model.Payments.Count</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i data-feather="trending-up"></i></div>
        <div class="stat-info">
            <div class="stat-label">T·ªïng ƒë√£ thu</div>
            <div class="stat-value" style="font-size: 18px;">@totalRevenue.ToString("N0")ƒë</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon yellow"><i data-feather="clock"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ch·ªù x√°c nh·∫≠n</div>
            <div class="stat-value">@pending</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red"><i data-feather="alert-triangle"></i></div>
        <div class="stat-info">
            <div class="stat-label">Qu√° h·∫°n</div>
            <div class="stat-value">@overdue</div>
        </div>
    </div>
</div>

<form method="get" class="filter-bar mb-20" id="filterForm">
    <div class="admin-search-wrapper" style="flex: 1; max-width: 340px;">
        <i data-feather="search" class="admin-search-icon"></i>
        <input name="SearchTerm" class="admin-search-input" value="@Model.SearchTerm" placeholder="T√¨m ng∆∞·ªùi thu√™, ch·ªß nh√†, m√£ Hƒê..." onchange="this.form.submit()" />
        <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" id="StatusFilterInput" />
    </div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button type="button" class="btn @(Model.StatusFilter == "All" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('All')">T·∫•t c·∫£ (@Model.Payments.Count)</button>
        <button type="button" class="btn @(Model.StatusFilter == "Pending" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Pending')">Ch·ªù</button>
        <button type="button" class="btn @(Model.StatusFilter == "Completed" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Completed')">Ho√†n th√†nh</button>
        <button type="button" class="btn @(Model.StatusFilter == "Overdue" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Overdue')">Qu√° h·∫°n</button>
        <button type="button" class="btn @(Model.StatusFilter == "Failed" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Failed')">Th·∫•t b·∫°i</button>
        <button type="button" class="btn @(Model.StatusFilter == "Refunded" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setFilter('Refunded')">Ho√†n ti·ªÅn</button>
    </div>
</form>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>H√≥a ƒë∆°n</th>
                    <th>Ng∆∞·ªùi thu√™</th>
                    <th>Ch·ªß nh√†</th>
                    <th>Lo·∫°i / K·ª≥</th>
                    <th>S·ªë ti·ªÅn</th>
                    <th>Bi√™n lai</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.FilteredPayments.Any())
                {
                    foreach (var p in Model.FilteredPayments)
                    {
                        var hasProof = !string.IsNullOrEmpty(p.PaymentProof);
                        <tr>
                            <td>
                                <div class="fw-700">#@p.Id</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Hƒê: @p.LeaseNumber</div>
                            </td>
                            <td style="color: var(--text-secondary);">@p.TenantName</td>
                            <td style="color: var(--text-secondary);">@p.LandlordName</td>
                            <td>
                                <div style="font-size: 12px;">@p.PaymentType</div>
                                <div style="font-size: 11px; color: var(--text-muted);">@p.BillingMonth/@p.BillingYear</div>
                            </td>
                            <td style="color: var(--success); font-weight: 700;">
                                @p.Amount.ToString("N0")ƒë
                                @if (p.LateFeeAmount.HasValue && p.LateFeeAmount > 0)
                                {
                                    <div style="font-size: 11px; color: var(--danger);">+ Ph·∫°t: @p.LateFeeAmount.Value.ToString("N0")ƒë</div>
                                }
                            </td>
                            <td>
                                @if (hasProof)
                                {
                                    <a href="@p.PaymentProof" target="_blank" class="btn btn-ghost btn-sm btn-icon" title="Xem bi√™n lai">
                                        <i data-feather="image" style="width: 14px;"></i>
                                    </a>
                                }
                                else
                                {
                                    <span style="color: var(--text-muted); font-size: 12px;">‚Äî</span>
                                }
                            </td>
                            <td>
                                @if ((p.Status.ToString() == "Pending" || p.Status.ToString() == "Overdue") && hasProof)
                                { <span class="badge badge-warning">Ch·ªù x√°c nh·∫≠n</span> }
                                else if (p.Status.ToString() == "Pending")
                                { <span class="badge badge-warning">Ch·ªù TT</span> }
                                else if (p.Status.ToString() == "Completed")
                                { <span class="badge badge-success">Ho√†n th√†nh ‚úì</span> }
                                else if (p.Status.ToString() == "OverduePaid")
                                { <span class="badge" style="background: rgba(234,88,12,0.15); color: #ea580c; border: 1px solid rgba(234,88,12,0.3);">Qu√° h·∫°n / ƒê√£ TP</span> }
                                else if (p.Status.ToString() == "Overdue")
                                { <span class="badge badge-danger">Qu√° h·∫°n</span> }
                                else if (p.Status.ToString() == "Failed")
                                { <span class="badge badge-danger">Th·∫•t b·∫°i</span> }
                                else if (p.Status.ToString() == "Refunded")
                                { <span class="badge" style="background: rgba(245,158,11,0.15); color: #f59e0b;">Ho√†n ti·ªÅn</span> }
                                else
                                { <span class="badge" style="background: rgba(148,163,184,0.15); color: var(--text-muted);">@p.Status</span> }
                            </td>
                            <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button class="btn btn-ghost btn-sm btn-icon" title="Chi ti·∫øt" onclick="openDetail(@p.Id)">
                                        <i data-feather="eye" style="width: 14px;"></i>
                                    </button>
                                    @if ((p.Status.ToString() == "Pending" || p.Status.ToString() == "Overdue") && hasProof)
                                    {
                                        <button class="btn btn-success btn-sm btn-icon" title="Duy·ªát" onclick="doConfirm(@p.Id, true, '@p.TenantName')">
                                            <i data-feather="check" style="width: 14px;"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm btn-icon" title="T·ª´ ch·ªëi" onclick="doConfirm(@p.Id, false, '@p.TenantName')">
                                            <i data-feather="x" style="width: 14px;"></i>
                                        </button>
                                    }
                                    @if (p.Status.ToString() == "Completed")
                                    {
                                        <button class="btn btn-ghost btn-sm" title="Ho√†n ti·ªÅn" onclick="doRefund(@p.Id, @p.Amount)" style="font-size: 11px; color: var(--warning);">
                                            <i data-feather="rotate-ccw" style="width: 12px;"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div style="font-size: 32px;">üí∏</div>
                                <p style="color: var(--text-muted); margin-top: 12px;">Kh√¥ng c√≥ giao d·ªãch ph√π h·ª£p.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div style="padding: 12px 16px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-muted);">
        Hi·ªÉn th·ªã @Model.FilteredPayments.Count / @Model.Payments.Count giao d·ªãch
    </div>
</div>

<!-- Payment data store -->
<script>
    window._ap = {};
    @foreach (var p in Model.FilteredPayments)
    {
        <text>
    window._ap[@p.Id] = {
        id: @p.Id,
        description: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.Description ?? "")),
        tenantName: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.TenantName ?? "")),
        landlordName: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.LandlordName ?? "")),
        amount: "@p.Amount.ToString("N0")",
        dueDate: "@p.DueDate.ToString("dd/MM/yyyy")",
        paidDate: "@(p.PaidDate.HasValue ? p.PaidDate.Value.ToString("dd/MM/yyyy HH:mm") : "")",
        paymentProof: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.PaymentProof ?? "")),
        transactionId: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.TransactionId ?? "")),
        notes: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(p.Notes ?? "")),
        paymentMethod: "@(p.PaymentMethod.HasValue ? p.PaymentMethod.Value.ToString() : "")"
    };
        </text>
    }
</script>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal" style="display: none;" onclick="this.style.display='none'">
    <div class="modal" style="max-width: 520px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title">Chi ti·∫øt giao d·ªãch</span>
            <button class="btn btn-ghost btn-sm btn-icon" onclick="document.getElementById('detailModal').style.display='none'">‚úï</button>
        </div>
        <div class="modal-body">
            <div style="display: grid; gap: 10px; font-size: 13px;" id="detailGrid"></div>
            <div id="d_proof_wrap" style="margin-top: 16px; display: none;">
                <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">üìé Bi√™n lai thanh to√°n</div>
                <a id="d_proof_link" href="#" target="_blank">
                    <img id="d_proof_img" src="" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border);" />
                </a>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('detailModal').style.display='none'">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Hidden forms -->
<form id="confirmForm" method="post" asp-page-handler="ConfirmPayment" style="display:none;">
    <input type="hidden" name="paymentId" id="cf_id" />
    <input type="hidden" name="isConfirmed" id="cf_ok" />
    <input type="hidden" name="notes" id="cf_notes" />
    <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
</form>
<form id="refundForm" method="post" asp-page-handler="Refund" style="display:none;">
    <input type="hidden" name="paymentId" id="rf_id" />
    <input type="hidden" name="amount" id="rf_amount" />
    <input type="hidden" name="reason" id="rf_reason" />
    <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
</form>

@section Scripts {
<style>
.admin-search-wrapper { position: relative; display: flex; align-items: center; }
.admin-search-icon { position: absolute; left: 10px; width: 14px; color: var(--text-muted); pointer-events: none; }
.admin-search-input { width: 100%; padding: 8px 12px 8px 32px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 13px; }
.admin-search-input:focus { outline: none; border-color: var(--accent); }
</style>
<script>
    function setFilter(s) { document.getElementById('StatusFilterInput').value = s; document.getElementById('filterForm').submit(); }

    function openDetail(id) {
        const p = window._ap[id];
        if (!p) return;
        const methodMap = { BankTransfer: 'Chuy·ªÉn kho·∫£n', Cash: 'Ti·ªÅn m·∫∑t', CreditCard: 'Th·∫ª t√≠n d·ª•ng', EWallet: 'V√≠ ƒëi·ªán t·ª≠' };
        const rows = [
            ['N·ªôi dung', p.description],
            ['Ng∆∞·ªùi thu√™', p.tenantName],
            ['Ch·ªß nh√†', p.landlordName],
            ['S·ªë ti·ªÅn', p.amount + 'ƒë'],
            ['Ph∆∞∆°ng th·ª©c', methodMap[p.paymentMethod] || '‚Äî'],
            ['M√£ giao d·ªãch', p.transactionId || '‚Äî'],
            ['H·∫°n ch√≥t', p.dueDate],
            ['Ng√†y thanh to√°n', p.paidDate || 'Ch∆∞a TT'],
            ['Ghi ch√∫', p.notes || '‚Äî'],
        ];
        document.getElementById('detailGrid').innerHTML = rows.map(([k, v]) =>
            `<div style="display:flex;justify-content:space-between;border-bottom:1px dashed var(--border);padding-bottom:8px;"><span style="color:var(--text-secondary)">${k}</span><span style="font-weight:600;max-width:260px;text-align:right">${v}</span></div>`
        ).join('');
        const proofWrap = document.getElementById('d_proof_wrap');
        if (p.paymentProof) {
            proofWrap.style.display = 'block';
            document.getElementById('d_proof_img').src = p.paymentProof;
            document.getElementById('d_proof_link').href = p.paymentProof;
        } else { proofWrap.style.display = 'none'; }
        document.getElementById('detailModal').style.display = 'flex';
    }

    function doConfirm(id, ok, name) {
        Swal.fire({
            title: ok ? 'X√°c nh·∫≠n thanh to√°n?' : 'T·ª´ ch·ªëi thanh to√°n?',
            html: ok ? `X√°c nh·∫≠n thanh to√°n t·ª´ <strong>${name}</strong>?` : `T·ª´ ch·ªëi thanh to√°n c·ªßa <strong>${name}</strong>?`,
            icon: ok ? 'question' : 'warning',
            showCancelButton: true,
            confirmButtonColor: ok ? '#10b981' : '#ef4444',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: ok ? 'X√°c nh·∫≠n ‚úì' : 'T·ª´ ch·ªëi',
            cancelButtonText: 'H·ªßy',
            input: 'text',
            inputPlaceholder: 'Ghi ch√∫ (tu·ª≥ ch·ªçn)...'
        }).then(r => {
            if (r.isConfirmed) {
                document.getElementById('cf_id').value = id;
                document.getElementById('cf_ok').value = String(ok);
                document.getElementById('cf_notes').value = r.value || '';
                document.getElementById('confirmForm').submit();
            }
        });
    }

    function doRefund(id, maxAmount) {
        Swal.fire({
            title: 'Ho√†n ti·ªÅn',
            html: `<input id="rfAmount" class="swal2-input" type="number" placeholder="S·ªë ti·ªÅn ho√†n (t·ªëi ƒëa ${maxAmount.toLocaleString()})" max="${maxAmount}" /><input id="rfReason" class="swal2-input" placeholder="L√Ω do ho√†n ti·ªÅn..." />`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'Ho√†n ti·ªÅn',
            cancelButtonText: 'H·ªßy',
            preConfirm: () => {
                const amt = document.getElementById('rfAmount').value;
                const rsn = document.getElementById('rfReason').value;
                if (!amt || !rsn) { Swal.showValidationMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!'); return false; }
                if (parseFloat(amt) > maxAmount) { Swal.showValidationMessage('S·ªë ti·ªÅn ho√†n v∆∞·ª£t qu√° s·ªë ti·ªÅn g·ªëc!'); return false; }
                return { amt, rsn };
            }
        }).then(r => {
            if (r.isConfirmed) {
                document.getElementById('rf_id').value = id;
                document.getElementById('rf_amount').value = r.value.amt;
                document.getElementById('rf_reason').value = r.value.rsn;
                document.getElementById('refundForm').submit();
            }
        });
    }
</script>
}
