@page
@model PropertyManagementSystemVer2.Web.Pages.Admin.UsersModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Ng∆∞·ªùi d√πng";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-20" style="padding: 12px 16px; background: var(--success-bg); color: var(--success); border-radius: var(--radius-sm); border: 1px solid var(--success);">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-20" style="padding: 12px 16px; background: var(--danger-bg); color: var(--danger); border-radius: var(--radius-sm); border: 1px solid var(--danger);">
        @TempData["ErrorMessage"]
    </div>
}

<div class="mb-20">
    <div class="page-title">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</div>
    <div class="page-desc">Qu·∫£n l√Ω t·∫•t c·∫£ t√†i kho·∫£n trong h·ªá th·ªëng</div>
</div>

<div class="stat-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
    <div class="stat-card">
        <div class="stat-icon purple"><i data-feather="shield"></i></div>
        <div class="stat-info">
            <div class="stat-label">Admin</div>
            <div class="stat-value">@Model.Users.Count(u => u.Role.ToString() == "Admin")</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue"><i data-feather="shield"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ch·ªß nh√†</div>
            <div class="stat-value">@Model.Users.Count(u => u.IsLandlord)</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i data-feather="shield"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ng∆∞·ªùi thu√™</div>
            <div class="stat-value">@Model.Users.Count(u => u.IsTenant && !u.IsLandlord)</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red"><i data-feather="slash"></i></div>
        <div class="stat-info">
            <div class="stat-label">B·ªã kho√°</div>
            <div class="stat-value">@Model.Users.Count(u => !u.IsActive)</div>
        </div>
    </div>
</div>

<form method="get" class="filter-bar" id="filterForm">
    <div class="admin-search-wrapper" style="flex: 1; max-width: 320px;">
        <i data-feather="search" class="admin-search-icon"></i>
        <input name="SearchTerm" class="admin-search-input" value="@Model.SearchTerm" placeholder="T√¨m ki·∫øm theo t√™n, email..." onchange="this.form.submit()" />
        <input type="hidden" name="RoleFilter" value="@Model.RoleFilter" id="RoleFilterInput" />
    </div>
    <div style="display: flex; gap: 8px;">
        <button type="button" class="btn @(Model.RoleFilter == "All" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setRole('All')">T·∫•t c·∫£</button>
        <button type="button" class="btn @(Model.RoleFilter == "Admin" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setRole('Admin')">Admin</button>
        <button type="button" class="btn @(Model.RoleFilter == "Landlord" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setRole('Landlord')">Ch·ªß nh√†</button>
        <button type="button" class="btn @(Model.RoleFilter == "Tenant" ? "btn-primary" : "btn-ghost") btn-sm" onclick="setRole('Tenant')">Ng∆∞·ªùi thu√™</button>
    </div>
</form>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>ƒêi·ªán tho·∫°i</th>
                    <th>Vai tr√≤</th>
                    <th>X√°c th·ª±c</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>ƒêƒÉng nh·∫≠p cu·ªëi</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.FilteredUsers != null && Model.FilteredUsers.Any())
                {
                    foreach (var user in Model.FilteredUsers)
                    {
                        var avatar = !string.IsNullOrEmpty(user.AvatarUrl) ? user.AvatarUrl : ("https://ui-avatars.com/api/?name=" + Uri.EscapeDataString(user.FullName) + "&background=6366f1&color=fff");
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 32px; height: 32px; flex-shrink: 0; position: relative;">
                                        <img src="@avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-primary);">@user.FullName</strong>
                                        <div class="text-sm text-muted">#@user.Id</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-muted">@user.Email</td>
                            <td class="text-muted">@user.PhoneNumber</td>
                            <td>
                                @if (user.Role.ToString() == "Admin")
                                {
                                    <span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">Admin</span>
                                }
                                else if (user.IsLandlord && user.IsTenant)
                                {
                                    <span class="badge" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">Ch·ªß nh√† & Thu√™</span>
                                }
                                else if (user.IsLandlord)
                                {
                                    <span class="badge" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">Ch·ªß nh√†</span>
                                }
                                else
                                {
                                    <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">Ng∆∞·ªùi thu√™</span>
                                }
                            </td>
                            <td>
                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                    @if (user.IsEmailVerified)
                                    {
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; font-size: 10px;">üìß Email</span>
                                    }
                                    @if (user.IsIdentityVerified)
                                    {
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; font-size: 10px;">ü™™ CCCD</span>
                                    }
                                </div>
                            </td>
                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">Ho·∫°t ƒë·ªông</span>
                                }
                                else
                                {
                                    <span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">B·ªã kho√°</span>
                                }
                            </td>
                            <td class="text-muted" style="font-size:13px;">
                                @(user.LastLoginAt.HasValue ? user.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm") : "")
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px;">
                                    <button class="btn btn-ghost btn-sm" onclick="viewUser(this)" data-user="@Html.Raw(System.Net.WebUtility.HtmlEncode(System.Text.Json.JsonSerializer.Serialize(new { 
                                        id = user.Id, 
                                        fullName = user.FullName, 
                                        email = user.Email, 
                                        phoneNumber = user.PhoneNumber, 
                                        roleName = user.Role.ToString() == "Admin" ? "Admin" : (user.IsLandlord && user.IsTenant ? "Ch·ªß nh√† & Ng∆∞·ªùi thu√™" : (user.IsLandlord ? "Ch·ªß nh√†" : "Ng∆∞·ªùi thu√™")), 
                                        isEmailVerified = user.IsEmailVerified, 
                                        isIdentityVerified = user.IsIdentityVerified, 
                                        isActive = user.IsActive, 
                                        createdAt = user.CreatedAt.ToString("dd/MM/yyyy"), 
                                        lastLogin = user.LastLoginAt.HasValue ? user.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm") : "Ch∆∞a ƒëƒÉng nh·∫≠p",
                                        avatar = avatar
                                    })))">Xem</button>
                                    
                                    <form method="post" asp-page-handler="ToggleStatus" style="margin: 0;">
                                        <input type="hidden" name="userId" value="@user.Id" />
                                        <input type="hidden" name="currentStatus" value="@(user.IsActive ? "true" : "false")" />
                                        <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                                        <input type="hidden" name="RoleFilter" value="@Model.RoleFilter" />
                                        
                                        @if (user.IsActive)
                                        {
                                            <button type="button" class="btn btn-danger btn-sm" title="Kho√° t√†i kho·∫£n" onclick="confirmToggleStatus(this.closest('form'), true)">
                                                <i data-feather="slash" style="width: 14px; height: 14px;"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-success btn-sm" title="M·ªü kho√°" onclick="confirmToggleStatus(this.closest('form'), false)">
                                                <i data-feather="check-circle" style="width: 14px; height: 14px;"></i>
                                            </button>
                                        }
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon" style="font-size: 32px; color: var(--text-muted);">üë•</div>
                                <p style="color: var(--text-muted); margin-top: 12px; font-weight: 500;">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ph√π h·ª£p.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div style="padding: 12px 14px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-muted);">
        Hi·ªÉn th·ªã @Model.FilteredUsers.Count / @Model.Users.Count ng∆∞·ªùi d√πng
    </div>
</div>

<!-- View User Modal -->
<div class="modal-overlay" id="userModal" style="display: none;" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title">Chi ti·∫øt ng∆∞·ªùi d√πng</span>
            <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-primary); border-radius: 10px;">
                <div style="width: 64px; height: 64px; flex-shrink: 0;">
                    <img id="mAvatar" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--border);" />
                </div>
                <div>
                    <div id="mName" style="font-size: 18px; font-weight: 700; color: var(--text-primary);"></div>
                    <div id="mEmail" class="text-muted text-sm"></div>
                    <div id="mStatusBadgeWrap" style="margin-top: 6px;"></div>
                </div>
            </div>
            
            <div style="display: grid; gap: 12px; padding-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">ID</span>
                    <span id="mId" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">ƒêi·ªán tho·∫°i</span>
                    <span id="mPhone" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Vai tr√≤</span>
                    <span id="mRole" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Email x√°c th·ª±c</span>
                    <span id="mEmailVeri" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">CCCD x√°c th·ª±c</span>
                    <span id="mCccdVeri" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Ng√†y t·∫°o</span>
                    <span id="mCreatedAt" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">ƒêƒÉng nh·∫≠p cu·ªëi</span>
                    <span id="mLastLogin" style="font-weight: 600; font-size: 13px;"></span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
            <form method="post" asp-page-handler="ToggleStatus" id="mFormAction" style="margin: 0;">
                <input type="hidden" name="userId" id="mUserId" />
                <input type="hidden" name="currentStatus" id="mCurrentStatus" />
                <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                <input type="hidden" name="RoleFilter" value="@Model.RoleFilter" />
                
                <button type="button" id="mActionBtn" class="btn" onclick="confirmToggleStatus(document.getElementById('mFormAction'), document.getElementById('mCurrentStatus').value === 'true')">
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function setRole(role) {
            document.getElementById('RoleFilterInput').value = role;
            document.getElementById('filterForm').submit();
        }

        function viewUser(btn) {
            const encodedData = btn.getAttribute('data-user');
            if (encodedData) {
                const user = JSON.parse(encodedData);
                
                document.getElementById('mAvatar').src = user.avatar;
                document.getElementById('mName').innerText = user.fullName;
                document.getElementById('mEmail').innerText = user.email;
                
                document.getElementById('mStatusBadgeWrap').innerHTML = user.isActive 
                    ? '<span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">Ho·∫°t ƒë·ªông</span>'
                    : '<span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">B·ªã kho√°</span>';

                document.getElementById('mId').innerText = "#" + user.id;
                document.getElementById('mPhone').innerText = user.phoneNumber;
                document.getElementById('mRole').innerText = user.roleName;
                
                document.getElementById('mEmailVeri').innerText = user.isEmailVerified ? "‚úÖ ƒê√£ x√°c th·ª±c" : "‚ùå Ch∆∞a x√°c th·ª±c";
                document.getElementById('mCccdVeri').innerText = user.isIdentityVerified ? "‚úÖ ƒê√£ x√°c th·ª±c" : "‚ùå Ch∆∞a x√°c th·ª±c";
                
                document.getElementById('mCreatedAt').innerText = user.createdAt;
                document.getElementById('mLastLogin').innerText = user.lastLogin;

                // Update action form inside modal
                document.getElementById('mUserId').value = user.id;
                document.getElementById('mCurrentStatus').value = user.isActive ? "true" : "false";
                
                const actionBtn = document.getElementById('mActionBtn');
                if (user.isActive) {
                    actionBtn.className = "btn btn-danger";
                    actionBtn.innerHTML = "Kho√° t√†i kho·∫£n";
                } else {
                    actionBtn.className = "btn btn-success";
                    actionBtn.innerHTML = "M·ªü kho√°";
                }

                document.getElementById('userModal').style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function confirmToggleStatus(form, isLocking) {
            const actionText = isLocking ? 'kho√°' : 'm·ªü kho√°';
            const confirmColor = isLocking ? '#ef4444' : '#10b981';
            
            Swal.fire({
                title: 'X√°c nh·∫≠n ' + actionText + '?',
                text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ' + actionText + ' ng∆∞·ªùi d√πng n√†y kh√¥ng?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: confirmColor,
                cancelButtonColor: '#94a3b8',
                confirmButtonText: 'ƒê·ªìng √Ω',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        }
    </script>
}
