@page
@model PropertyManagementSystemVer2.Web.Pages.Tenant.PaymentsModel
@{
    ViewData["Title"] = "Thanh to√°n";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-20" style="padding: 12px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 8px; border: 1px solid #10b981; display: flex; align-items: center; gap: 8px;">
        <i data-feather="check-circle" style="width: 16px;"></i> @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-20" style="padding: 12px 16px; background: rgba(239,68,68,0.1); color: #ef4444; border-radius: 8px; border: 1px solid #ef4444; display: flex; align-items: center; gap: 8px;">
        <i data-feather="alert-circle" style="width: 16px;"></i> @TempData["ErrorMessage"]
    </div>
}

<div class="mb-20">
    <div class="page-title">Thanh to√°n</div>
    <div class="page-desc">L·ªãch s·ª≠ thanh to√°n v√† c√°c ho√° ƒë∆°n c·ªßa b·∫°n</div>
</div>

@{
    var pending = Model.Payments.Count(p => p.Status.ToString() == "Pending");
    var overdue = Model.Payments.Count(p => p.Status.ToString() == "Overdue");
    var completed = Model.Payments.Count(p => p.Status.ToString() == "Completed");
    var totalPending = Model.Payments.Where(p => p.Status.ToString() == "Pending" || p.Status.ToString() == "Overdue").Sum(p => p.Amount);
}

<div class="stat-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
    <div class="stat-card">
        <div class="stat-icon yellow"><i data-feather="clock"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ch·ªù thanh to√°n</div>
            <div class="stat-value">@pending</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red"><i data-feather="alert-triangle"></i></div>
        <div class="stat-info">
            <div class="stat-label">Qu√° h·∫°n</div>
            <div class="stat-value">@overdue</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i data-feather="check-circle"></i></div>
        <div class="stat-info">
            <div class="stat-label">ƒê√£ thanh to√°n</div>
            <div class="stat-value">@completed</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>H√≥a ƒë∆°n</th>
                    <th>N·ªôi dung</th>
                    <th>Ch·ªß nh√†</th>
                    <th>H·∫°n ch√≥t</th>
                    <th>S·ªë ti·ªÅn (VNƒê)</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Payments.Any())
                {
                    foreach (var payment in Model.Payments)
                    {
                        var isPayable = payment.Status.ToString() == "Pending" || payment.Status.ToString() == "Overdue";
                        var isOverdue = payment.DueDate < DateTime.Now && isPayable;
                        var hasBank = !string.IsNullOrEmpty(payment.LandlordBankAccount) && !string.IsNullOrEmpty(payment.LandlordBankName);
                        <tr>
                            <td>
                                <div class="fw-700" style="color: var(--text-primary);">#@payment.Id</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Hƒê: @payment.LeaseNumber</div>
                            </td>
                            <td>
                                <div class="fw-600">@payment.Description</div>
                                <div style="font-size: 11px; color: var(--text-muted);">K·ª≥: @payment.BillingMonth/@payment.BillingYear</div>
                            </td>
                            <td style="color: var(--text-secondary);">@payment.LandlordName</td>
                            <td>
                                <div class="@(isOverdue ? "fw-600" : "")" style="color: @(isOverdue ? "var(--danger)" : "var(--text-secondary)");">
                                    @payment.DueDate.ToString("dd/MM/yyyy")
                                </div>
                            </td>
                            <td>
                                <div style="color: var(--success); font-weight: 700;">@payment.Amount.ToString("N0")ƒë</div>
                                @if (payment.LateFeeAmount.HasValue && payment.LateFeeAmount > 0)
                                {
                                    <div style="font-size: 11px; color: var(--danger);">+ Ph·∫°t: @payment.LateFeeAmount.Value.ToString("N0")ƒë</div>
                                }
                            </td>
                            <td>
                                @if (payment.Status.ToString() == "Pending")
                                {
                                    <span class="badge badge-warning">Ch·ªù thanh to√°n</span>
                                }
                                else if (payment.Status.ToString() == "Overdue")
                                {
                                    <span class="badge badge-danger">Qu√° h·∫°n</span>
                                }
                                else if (payment.Status.ToString() == "Completed")
                                {
                                    <span class="badge badge-success">ƒê√£ thanh to√°n</span>
                                }
                                else if (payment.Status.ToString() == "Failed")
                                {
                                    <span class="badge badge-danger">Th·∫•t b·∫°i</span>
                                }
                                else if (payment.Status.ToString() == "OverduePaid")
                                {
                                    <span class="badge" style="background: rgba(234,88,12,0.15); color: #ea580c; border: 1px solid rgba(234,88,12,0.3);">Qu√° h·∫°n / ƒê√£ TP</span>
                                }
                                else
                                {
                                    <span class="badge" style="background: rgba(148,163,184,0.15); color: var(--text-muted);">@payment.Status</span>
                                }
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px;">
                                    @if (!string.IsNullOrEmpty(payment.PaymentProof))
                                    {
                                        <a href="@payment.PaymentProof" target="_blank" class="btn btn-ghost btn-sm btn-icon" title="Xem bi√™n lai ƒë√£ n·ªôp">
                                            <i data-feather="image" style="width: 14px;"></i>
                                        </a>
                                    }
                                    <button class="btn btn-secondary btn-sm" onclick="openDetail(@payment.Id)" style="padding: 0 8px;">
                                        <i data-feather="eye" style="width: 14px; margin-right: 4px;"></i>Chi ti·∫øt
                                    </button>
                                    @if (isPayable)
                                    {
                                        <button class="btn btn-primary btn-sm" onclick="openPayModal(@payment.Id)" data-id="@payment.Id">
                                            <i data-feather="credit-card" style="width: 14px; margin-right: 4px;"></i>Thanh to√°n
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-icon" style="font-size: 32px;">üí≥</div>
                                <p style="color: var(--text-muted); margin-top: 12px;">B·∫°n ch∆∞a c√≥ h√≥a ƒë∆°n n√†o.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div style="padding: 12px 16px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-muted);">
        Hi·ªÉn th·ªã @Model.Payments.Count h√≥a ƒë∆°n
    </div>
</div>

<!-- Payment data store (avoids HtmlEncode issue with data attributes) -->
<script>
    window._payments = {};
    @foreach (var payment in Model.Payments)
    {
        var hasBank2 = !string.IsNullOrEmpty(payment.LandlordBankAccount) && !string.IsNullOrEmpty(payment.LandlordBankName);
        <text>
    window._payments[@payment.Id] = {
        id: @payment.Id,
        description: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.Description ?? "")),
        amount: @payment.Amount,
        amountFormatted: "@payment.Amount.ToString("N0")",
        lateFeeAmount: @(payment.LateFeeAmount.HasValue ? payment.LateFeeAmount.Value.ToString(System.Globalization.CultureInfo.InvariantCulture) : "0"),
        lateFeeFormatted: "@(payment.LateFeeAmount.HasValue && payment.LateFeeAmount > 0 ? payment.LateFeeAmount.Value.ToString("N0") : "0")",
        totalAmount: @((payment.Amount + (payment.LateFeeAmount ?? 0)).ToString(System.Globalization.CultureInfo.InvariantCulture)),
        totalFormatted: "@((payment.Amount + (payment.LateFeeAmount ?? 0)).ToString("N0"))",
        isOverdue: @(payment.Status.ToString() == "Overdue" ? "true" : "false"),
        dueDate: "@payment.DueDate.ToString("dd/MM/yyyy")",
        landlordName: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.LandlordName ?? "")),
        landlordBankAccount: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.LandlordBankAccount ?? "")),
        landlordBankName: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.LandlordBankName ?? "")),
        landlordBankHolder: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.LandlordBankAccountHolder ?? "")),
        hasBank: @(hasBank2 ? "true" : "false"),
        paymentProof: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.PaymentProof ?? "")),
        paymentMethod: "@(payment.PaymentMethod.ToString() ?? "")",
        transactionId: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(payment.TransactionId ?? "")),
        paidDate: "@(payment.PaidDate?.ToString("dd/MM/yyyy HH:mm") ?? "")"
    };
        </text>
    }
</script>

<!-- ===== Validation and Detail Modal ===== -->
<div class="modal-overlay" id="detailModal" style="display: none;" onclick="closeDetail()">
    <div class="modal" style="max-width: 500px; width: 95%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title"><i data-feather="file-text" style="width: 16px; margin-right: 6px;"></i>Chi ti·∫øt thanh to√°n</span>
            <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeDetail()">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;" id="d_desc"></div>
                    <div style="font-size: 28px; font-weight: 800; color: var(--accent);" id="d_amount"></div>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Ch·ªß nh√†</span>
                    <span id="d_landlord" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Ph∆∞∆°ng th·ª©c</span>
                    <span id="d_method" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">M√£ giao d·ªãch</span>
                    <span id="d_txid" style="font-weight: 600; font-family: monospace; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">H·∫°n ch√≥t</span>
                    <span id="d_due" style="font-weight: 600; font-size: 13px;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 13px;">Ng√†y x√°c nh·∫≠n/thanh to√°n</span>
                    <span id="d_paid" style="font-weight: 600; font-size: 13px;"></span>
                </div>
            </div>
            <div id="d_proof_wrap" style="margin-top: 16px; display: none;">
                <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">üìé Bi√™n lai thanh to√°n ƒë√≠nh k√®m</div>
                <a id="d_proof_link" href="#" target="_blank">
                    <img id="d_proof_img" src="" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border);" />
                </a>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDetail()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- ===== Payment Modal ===== -->
<div class="modal-overlay" id="payModal" style="display: none;" onclick="closePayModal()">
    <div class="modal" style="max-width: 580px; width: 95%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title"><i data-feather="credit-card" style="width: 16px; margin-right: 6px;"></i>Thanh to√°n h√≥a ƒë∆°n</span>
            <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closePayModal()">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 20px;">

            <!-- Invoice summary -->
            <div style="background: var(--bg-primary); border-radius: 10px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;" id="pDescription"></div>
                <!-- Base amount -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; color: var(--text-muted);">Ti·ªÅn thu√™ g·ªëc</span>
                    <span style="font-size: 15px; font-weight: 700; color: var(--text-primary);" id="pAmount"></span>
                </div>
                <!-- Late fee row (hidden if no late fee) -->
                <div id="pLateFeeRow" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 4px; padding: 6px 8px; background: rgba(239,68,68,0.08); border-radius: 6px; border: 1px solid rgba(239,68,68,0.2);">
                    <span style="font-size: 12px; color: var(--danger);">‚ö†Ô∏è Ph√≠ qu√° h·∫°n</span>
                    <span style="font-size: 14px; font-weight: 700; color: var(--danger);" id="pLateFee"></span>
                </div>
                <!-- Total -->
                <div id="pTotalRow" style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; margin-top: 4px; border-top: 1px dashed var(--border);">
                    <span style="font-size: 13px; color: var(--text-muted); font-weight: 600;">T·ªîNG C·∫¶N THANH TO√ÅN</span>
                    <span style="font-size: 22px; font-weight: 800; color: var(--accent);" id="pTotal"></span>
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">H·∫°n ch√≥t: <span id="pDueDate"></span></div>
            </div>

            <!-- Choose method -->
            <div style="margin-bottom: 20px;">
                <label class="form-label" style="font-weight: 600; margin-bottom: 10px; display: block;">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <label id="lblBankTransfer" class="method-card method-selected" for="m_bank" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid var(--accent); border-radius: 10px; cursor: pointer; background: rgba(99,102,241,0.05);">
                        <input type="radio" id="m_bank" name="payMethod" value="BankTransfer" style="display:none;" checked onchange="onMethodChange('BankTransfer')"/>
                        <span style="font-size: 22px;">üè¶</span>
                        <div><div style="font-weight: 600; font-size: 13px;">Chuy·ªÉn kho·∫£n</div><div style="font-size: 11px; color: var(--text-muted);">Qu√©t QR VietQR</div></div>
                    </label>
                    <label id="lblCash" class="method-card" for="m_cash" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer;">
                        <input type="radio" id="m_cash" name="payMethod" value="Cash" style="display:none;" onchange="onMethodChange('Cash')"/>
                        <span style="font-size: 22px;">üíµ</span>
                        <div><div style="font-weight: 600; font-size: 13px;">Ti·ªÅn m·∫∑t</div><div style="font-size: 11px; color: var(--text-muted);">Tr·∫£ tr·ª±c ti·∫øp</div></div>
                    </label>
                </div>
            </div>

            <!-- VietQR Section -->
            <div id="vietQrSection" style="margin-bottom: 20px;">
                <div id="bankInfoBlock" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start;">
                        <div>
                            <div style="background: var(--bg-primary); border-radius: 10px; padding: 14px; border: 1px solid var(--border); font-size: 13px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Ng√¢n h√†ng</span>
                                    <span id="bankName" style="font-weight: 700; color: var(--text-primary);"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">S·ªë t√†i kho·∫£n</span>
                                    <span id="bankAccount" style="font-weight: 700; color: var(--text-primary); font-family: monospace;"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-muted);">Ch·ªß t√†i kho·∫£n</span>
                                    <span id="bankHolder" style="font-weight: 700; color: var(--text-primary);"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-muted);">S·ªë ti·ªÅn</span>
                                    <span id="bankAmount" style="font-weight: 800; color: var(--danger); font-size: 15px;"></span>
                                </div>
                            </div>
                            <div style="margin-top: 8px; padding: 10px; background: rgba(59,130,246,0.08); border-radius: 8px; font-size: 12px; color: var(--text-muted);">
                                üí° Qu√©t m√£ QR b·∫±ng app ng√¢n h√†ng ƒë·ªÉ chuy·ªÉn kho·∫£n nhanh. N·ªôi dung chuy·ªÉn kho·∫£n ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn.
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <img id="qrImg" src="" style="width: 160px; height: 160px; border-radius: 10px; border: 2px solid var(--border); display: block;" loading="lazy" />
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">Qu√©t b·∫±ng app ng√¢n h√†ng</div>
                        </div>
                    </div>
                </div>
                <div id="noBankBlock" style="display: none; padding: 14px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; font-size: 13px; color: var(--text-muted);">
                    ‚ö†Ô∏è Ch·ªß nh√† ch∆∞a c·∫≠p nh·∫≠t th√¥ng tin ng√¢n h√†ng. Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp ƒë·ªÉ thanh to√°n.
                </div>
            </div>

            <!-- Upload bill section -->
            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label" style="font-weight: 600;">Upload bi√™n lai <span id="billRequired" style="color: var(--danger);">*</span></label>
                <div id="billDropZone" style="border: 2px dashed var(--border); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.2s;" 
                     onclick="document.getElementById('billFileInput').click()"
                     ondragover="event.preventDefault(); this.style.borderColor='var(--accent)'"
                     ondragleave="this.style.borderColor='var(--border)'"
                     ondrop="handleDrop(event)">
                    <div id="billPlaceholder">
                        <div style="font-size: 28px; margin-bottom: 8px;">üìé</div>
                        <div style="font-size: 13px; color: var(--text-muted);">K√©o th·∫£ ho·∫∑c <strong style="color: var(--accent);">ch·ªçn t·ªáp</strong></div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">PNG, JPG, PDF t·ªëi ƒëa 5MB</div>
                    </div>
                    <div id="billPreviewWrap" style="display: none;">
                        <img id="billPreview" src="" style="max-height: 120px; border-radius: 8px; margin: 0 auto;" />
                        <div id="billFileName" style="font-size: 12px; color: var(--text-muted); margin-top: 6px;"></div>
                    </div>
                    <input type="file" id="billFileInput" accept="image/*,application/pdf" style="display: none;" onchange="handleBillFile(event)" />
                </div>
            </div>

            <!-- Transaction ID -->
            <div class="form-group" id="txIdGroup" style="margin-bottom: 16px;">
                <label class="form-label" style="font-weight: 600;">M√£ giao d·ªãch (tu·ª≥ ch·ªçn)</label>
                <input type="text" class="form-control" id="txIdInput" placeholder="Nh·∫≠p m√£ giao d·ªãch ng√¢n h√†ng n·∫øu c√≥..."/>
            </div>

            <!-- Notes -->
            <div class="form-group" style="margin-bottom: 4px;">
                <label class="form-label" style="font-weight: 600;">Ghi ch√∫</label>
                <textarea class="form-control" id="notesInput" placeholder="Ghi ch√∫ th√™m n·∫øu c·∫ßn..." rows="2" style="resize: none; font-size: 13px;"></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePayModal()">H·ªßy</button>
            <button class="btn btn-primary" id="submitPayBtn" onclick="submitPayment()">
                <i data-feather="send" style="width: 14px; margin-right: 6px;"></i>X√°c nh·∫≠n ƒë√£ chuy·ªÉn kho·∫£n
            </button>
        </div>
    </div>
</div>

<!-- Hidden form for POST -->
<form id="paymentForm" method="post" asp-page-handler="MakePayment" enctype="multipart/form-data" style="display:none;">
    <input type="hidden" id="f_paymentId" name="paymentId" />
    <input type="hidden" id="f_paymentMethod" name="paymentMethod" />
    <input type="hidden" id="f_transactionId" name="transactionId" />
    <input type="hidden" id="f_notes" name="notes" />
    <input type="file" id="f_paymentProof" name="PaymentProofFile" style="display:none;" />
</form>

@section Scripts {
    <script>
        let currentPayment = null;
        let currentMethod = 'BankTransfer';

        // Bank name ‚Üí VietQR BIN mapping (c√°c ng√¢n h√†ng ph·ªï bi·∫øn ·ªü VN)
        const BANK_BINS = {
            'vietcombank': '970436',
            'vcb': '970436',
            'techcombank': '970407',
            'tcb': '970407',
            'vietinbank': '970415',
            'ctg': '970415',
            'agribank': '970405',
            'acb': '970416',
            'bidv': '970418',
            'mbbank': '970422',
            'mb': '970422',
            'sacombank': '970403',
            'stb': '970403',
            'vpbank': '970432',
            'vpb': '970432',
            'tpbank': '970423',
            'hdbank': '970437',
            'vib': '970441',
            'ocb': '970448',
            'msb': '970426',
            'seabank': '970440',
            'abbank': '970425',
            'eximbank': '970431',
            'ncb': '970419',
            'pvcombank': '970412',
            'baovietbank': '970438',
            'nam a bank': '970428',
            'namabank': '970428',
            'kienlongbank': '970452',
            'lpbank': '970449',
            'lienvietpostbank': '970449',
        };

        function getBankBin(bankName) {
            if (!bankName) return null;
            const key = bankName.toLowerCase().trim();
            for (const [name, bin] of Object.entries(BANK_BINS)) {
                if (key.includes(name) || name.includes(key)) return bin;
            }
            return null;
        }

        function openDetail(id) {
            const p = window._payments[id];
            if (!p) return;
            document.getElementById('d_desc').innerText = p.description;
            
            let amountHtml = `<div>${p.amountFormatted}ƒë</div>`;
            if (p.lateFeeAmount > 0) {
                amountHtml += `<div style="font-size: 14px; color: var(--danger); margin-top: 4px;">+ Ph·∫°t: ${p.lateFeeFormatted}ƒë</div>`;
            }
            document.getElementById('d_amount').innerHTML = amountHtml;

            document.getElementById('d_landlord').innerText = p.landlordName || '‚Äî';
            
            const methodMap = { BankTransfer: 'Chuy·ªÉn kho·∫£n', Cash: 'Ti·ªÅn m·∫∑t', CreditCard: 'Th·∫ª t√≠n d·ª•ng', EWallet: 'V√≠ ƒëi·ªán t·ª≠' };
            document.getElementById('d_method').innerText = methodMap[p.paymentMethod] || p.paymentMethod || '‚Äî';
            document.getElementById('d_txid').innerText = p.transactionId || '‚Äî';
            document.getElementById('d_due').innerText = p.dueDate;
            document.getElementById('d_paid').innerText = p.paidDate || 'Ch∆∞a thanh to√°n';

            const proofWrap = document.getElementById('d_proof_wrap');
            if (p.paymentProof) {
                document.getElementById('d_proof_img').src = p.paymentProof;
                document.getElementById('d_proof_link').href = p.paymentProof;
                proofWrap.style.display = 'block';
            } else {
                proofWrap.style.display = 'none';
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeDetail() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function openPayModal(id) {
            currentPayment = window._payments[id];
            if (!currentPayment) { console.error('Payment not found:', id); return; }

            document.getElementById('pDescription').innerText = currentPayment.description;
            document.getElementById('pAmount').innerText = currentPayment.amountFormatted + '‚Ç´';
            document.getElementById('pDueDate').innerText = currentPayment.dueDate;

            // Hi·ªÉn th·ªã ph√≠ qu√° h·∫°n n·∫øu c√≥
            const lateFeeRow = document.getElementById('pLateFeeRow');
            const totalEl = document.getElementById('pTotal');
            if (currentPayment.lateFeeAmount > 0) {
                document.getElementById('pLateFee').innerText = '+' + currentPayment.lateFeeFormatted + '‚Ç´';
                lateFeeRow.style.display = 'flex';
            } else {
                lateFeeRow.style.display = 'none';
            }
            totalEl.innerText = currentPayment.totalFormatted + '‚Ç´';

            currentMethod = 'BankTransfer';
            document.getElementById('m_bank').checked = true;
            setMethodUI('BankTransfer');
            loadBankInfo();

            // Clear form
            document.getElementById('txIdInput').value = '';
            document.getElementById('notesInput').value = '';
            clearBillPreview();

            document.getElementById('payModal').style.display = 'flex';
            feather.replace();
        }

        function closePayModal() {
            document.getElementById('payModal').style.display = 'none';
        }

        function onMethodChange(method) {
            currentMethod = method;
            setMethodUI(method);
            loadBankInfo();
        }

        function setMethodUI(method) {
            const lblBank = document.getElementById('lblBankTransfer');
            const lblCash = document.getElementById('lblCash');
            const activeStyle = 'border: 2px solid var(--accent); background: rgba(99,102,241,0.05);';
            const normalStyle = 'border: 2px solid var(--border); background: transparent;';

            if (method === 'BankTransfer') {
                lblBank.style.cssText += activeStyle;
                lblCash.style.cssText = 'display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;cursor:pointer;' + normalStyle;
                document.getElementById('vietQrSection').style.display = 'block';
                document.getElementById('txIdGroup').style.display = 'block';
                document.getElementById('submitPayBtn').innerHTML = '<i data-feather="send" style="width:14px;margin-right:6px;"></i>X√°c nh·∫≠n ƒë√£ chuy·ªÉn kho·∫£n';
            } else {
                lblCash.style.cssText += activeStyle;
                lblBank.style.cssText = 'display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;cursor:pointer;' + normalStyle;
                document.getElementById('vietQrSection').style.display = 'none';
                document.getElementById('txIdGroup').style.display = 'none';
                document.getElementById('submitPayBtn').innerHTML = '<i data-feather="check" style="width:14px;margin-right:6px;"></i>X√°c nh·∫≠n ƒë√£ n·ªôp ti·ªÅn m·∫∑t';
            }
            feather.replace();
        }

        function loadBankInfo() {
            if (!currentPayment || currentMethod !== 'BankTransfer') return;

            const bankInfoBlock = document.getElementById('bankInfoBlock');
            const noBankBlock = document.getElementById('noBankBlock');

            if (!currentPayment.hasBank) {
                bankInfoBlock.style.display = 'none';
                noBankBlock.style.display = 'block';
                return;
            }

            bankInfoBlock.style.display = 'flex';
            bankInfoBlock.style.display = 'block';
            noBankBlock.style.display = 'none';

            document.getElementById('bankName').innerText = currentPayment.landlordBankName;
            document.getElementById('bankAccount').innerText = currentPayment.landlordBankAccount;
            document.getElementById('bankHolder').innerText = currentPayment.landlordBankHolder;
            document.getElementById('bankAmount').innerText = currentPayment.totalFormatted + '‚Ç´';

            // Generate VietQR URL
            const bin = getBankBin(currentPayment.landlordBankName);
            const qrImg = document.getElementById('qrImg');

            if (bin) {
                const info = encodeURIComponent('Thanh toan ' + currentPayment.description);
                const holder = encodeURIComponent(currentPayment.landlordBankHolder || '');
                const amount = Math.round(currentPayment.totalAmount);
                const qrUrl = `https://img.vietqr.io/image/${bin}-${currentPayment.landlordBankAccount}-compact2.png?amount=${amount}&addInfo=${info}&accountName=${holder}`;
                qrImg.src = qrUrl;
                qrImg.style.display = 'block';
            } else {
                // Fallback: show QR via generic VietQR with account number only
                qrImg.src = `https://img.vietqr.io/image/${currentPayment.landlordBankAccount}-compact2.png`;
                qrImg.style.display = 'block';
            }
        }

        function handleBillFile(event) {
            const file = event.target.files[0];
            if (file) showBillPreview(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) {
                document.getElementById('billFileInput').files = event.dataTransfer.files;
                showBillPreview(file);
            }
            document.getElementById('billDropZone').style.borderColor = 'var(--border)';
        }

        function showBillPreview(file) {
            document.getElementById('billPlaceholder').style.display = 'none';
            document.getElementById('billPreviewWrap').style.display = 'block';
            document.getElementById('billFileName').innerText = file.name + ' (' + (file.size / 1024).toFixed(0) + ' KB)';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => { document.getElementById('billPreview').src = e.target.result; };
                reader.readAsDataURL(file);
                document.getElementById('billPreview').style.display = 'block';
            } else {
                document.getElementById('billPreview').style.display = 'none';
            }
        }

        function clearBillPreview() {
            document.getElementById('billPlaceholder').style.display = 'block';
            document.getElementById('billPreviewWrap').style.display = 'none';
            document.getElementById('billFileInput').value = '';
        }

        function submitPayment() {
            if (!currentPayment) return;

            // Validate: need at least bill or txId for BankTransfer
            const billFile = document.getElementById('billFileInput').files[0];
            const txId = document.getElementById('txIdInput').value.trim();

            if (currentMethod === 'BankTransfer' && !billFile && !txId) {
                Swal.fire({
                    title: 'Thi·∫øu bi√™n lai',
                    text: 'Vui l√≤ng upload ·∫£nh bi√™n lai chuy·ªÉn kho·∫£n ho·∫∑c nh·∫≠p m√£ giao d·ªãch.',
                    icon: 'warning',
                    confirmButtonColor: 'var(--accent)'
                });
                return;
            }

            // Copy file to hidden form input
            const f_proof = document.getElementById('f_paymentProof');
            if (billFile) {
                const dt = new DataTransfer();
                dt.items.add(billFile);
                f_proof.files = dt.files;
            }

            document.getElementById('f_paymentId').value = currentPayment.id;
            document.getElementById('f_paymentMethod').value = currentMethod;
            document.getElementById('f_transactionId').value = txId;
            document.getElementById('f_notes').value = document.getElementById('notesInput').value;

            document.getElementById('paymentForm').submit();
        }
    </script>
}
