@page
@using PropertyManagementSystemVer2.DAL.Enums
@model PropertyManagementSystemVer2.Web.Pages.Tenant.LeasesModel
@{
    ViewData["Title"] = "H·ª£p ƒë·ªìng c·ªßa t√¥i";
}

<style>
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: var(--bg-card); padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 16px; border: 1px solid var(--border); transition: all 0.3s; cursor: pointer; text-decoration: none; color: inherit; }
    .stat-card:hover { transform: translateY(-2px); border-color: var(--accent-light); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .stat-card.active { border-color: var(--accent-light); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .stat-icon.yellow { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .stat-icon.blue { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .stat-icon.red { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .stat-info { flex: 1; }
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
</style>

<div class="mb-20" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
        <div class="page-title">H·ª£p ƒë·ªìng c·ªßa b·∫°n</div>
        <div class="page-desc">Xem v√† qu·∫£n l√Ω c√°c h·ª£p ƒë·ªìng thu√™ nh√† hi·ªán t·∫°i v√† qu√° kh·ª©</div>
    </div>
</div>

<div class="stat-grid">
    <div class="stat-card @(Model.StatusFilter == LeaseStatus.Active ? "active" : "")" onclick="setFilter('Active')">
        <div class="stat-icon green"><i data-feather="file-text" style="width: 20px;"></i></div>
        <div class="stat-info">
            <div class="stat-label">ƒêang hi·ªáu l·ª±c</div>
            <div class="stat-value">@Model.AllLeases.Count(l => l.Status == LeaseStatus.Active)</div>
        </div>
    </div>
    <div class="stat-card @(Model.StatusFilter == LeaseStatus.Pending ? "active" : "")" onclick="setFilter('Pending')">
        <div class="stat-icon yellow"><i data-feather="file-text" style="width: 20px;"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ch·ªù k√Ω</div>
            <div class="stat-value">@Model.AllLeases.Count(l => l.Status == LeaseStatus.Pending)</div>
        </div>
    </div>
    <div class="stat-card @(Model.StatusFilter == LeaseStatus.Expired ? "active" : "")" onclick="setFilter('Expired')">
        <div class="stat-icon blue"><i data-feather="file-text" style="width: 20px;"></i></div>
        <div class="stat-info">
            <div class="stat-label">H·∫øt h·∫°n</div>
            <div class="stat-value">@Model.AllLeases.Count(l => l.Status == LeaseStatus.Expired)</div>
        </div>
    </div>
    <div class="stat-card @(Model.StatusFilter == LeaseStatus.Terminated ? "active" : "")" onclick="setFilter('Terminated')">
        <div class="stat-icon red"><i data-feather="file-text" style="width: 20px;"></i></div>
        <div class="stat-info">
            <div class="stat-label">Ch·∫•m d·ª©t</div>
            <div class="stat-value">@Model.AllLeases.Count(l => l.Status == LeaseStatus.Terminated)</div>
        </div>
    </div>
</div>

<div class="card mb-20">
    <form method="get" id="filterForm" class="filter-bar" style="margin-bottom: 0;">
        <div class="header-search" style="flex: 1; min-width: 200px;">
            <i data-feather="search" style="color: var(--text-muted); width: 14px;"></i>
            <input type="text" name="SearchTerm" value="@Model.SearchTerm" placeholder="T√¨m m√£ Hƒê, Ch·ªß nh√†, B·∫•t ƒë·ªông s·∫£n..." style="width: 100%; border: none; outline: none; background: transparent; padding-left: 8px;" />
        </div>
        <input type="hidden" name="StatusFilter" id="statusFilter" value="@Model.StatusFilter" />
        <button type="button" class="btn btn-sm @(!Model.StatusFilter.HasValue ? "btn-primary" : "btn-ghost")" onclick="setFilter('')">T·∫•t c·∫£ (@Model.AllLeases.Count)</button>
        <button type="button" class="btn btn-sm @(Model.StatusFilter == LeaseStatus.Active ? "btn-primary text-green" : "btn-ghost text-green")" style="border-color: var(--success);" onclick="setFilter('Active')">Hi·ªáu l·ª±c (@Model.AllLeases.Count(l => l.Status == LeaseStatus.Active))</button>
        <button type="button" class="btn btn-sm @(Model.StatusFilter == LeaseStatus.Pending ? "btn-primary text-yellow" : "btn-ghost text-yellow")" style="border-color: var(--warning);" onclick="setFilter('Pending')">Ch·ªù k√Ω (@Model.AllLeases.Count(l => l.Status == LeaseStatus.Pending))</button>
        <button type="button" class="btn btn-sm @(Model.StatusFilter == LeaseStatus.Expired ? "btn-primary text-gray" : "btn-ghost text-gray")" style="border-color: var(--text-muted);" onclick="setFilter('Expired')">H·∫øt h·∫°n (@Model.AllLeases.Count(l => l.Status == LeaseStatus.Expired))</button>
        <button type="button" class="btn btn-sm @(Model.StatusFilter == LeaseStatus.Terminated ? "btn-primary text-red" : "btn-ghost text-red")" style="border-color: var(--danger);" onclick="setFilter('Terminated')">Ch·∫•m d·ª©t (@Model.AllLeases.Count(l => l.Status == LeaseStatus.Terminated))</button>
    </form>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>M√£ Hƒê</th>
                    <th>B·∫•t ƒë·ªông s·∫£n</th>
                    <th>Ch·ªß nh√†</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ch·ªØ k√Ω</th>
                    <th>Ti·ªÅn thu√™/th√°ng</th>
                    <th>Th·ªùi h·∫°n</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Leases != null && Model.Leases.Any())
                {
                    foreach (var lease in Model.Leases)
                    {
                        <tr>
                            <td class="fw-700" style="color: var(--accent-light);">@lease.LeaseNumber</td>
                            <td>
                                <div class="fw-600" style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @lease.PropertyTitle
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">ID: @lease.PropertyId</div>
                            </td>
                            <td>@lease.LandlordName</td>
                            <td>
                                @if (lease.Status == LeaseStatus.Active) { <span class="badge badge-success">Hi·ªáu l·ª±c</span> }
                                else if (lease.Status == LeaseStatus.Pending) { <span class="badge badge-warning">Ch·ªù k√Ω</span> }
                                else if (lease.Status == LeaseStatus.Expired) { <span class="badge badge-gray">H·∫øt h·∫°n</span> }
                                else if (lease.Status == LeaseStatus.Terminated) { <span class="badge badge-danger">Ch·∫•m d·ª©t</span> }
                            </td>
                            <td>
                                <div style="display: flex; gap: 4px;">
                                    <span style="font-size: 11px;" class="badge @(lease.LandlordSigned ? "badge-success" : "badge-gray")">
                                        @(lease.LandlordSigned ? "‚úì Ch·ªß nh√†" : "‚è≥ Ch·ªß nh√†")
                                    </span>
                                    <span style="font-size: 11px;" class="badge @(lease.TenantSigned ? "badge-success" : "badge-gray")">
                                        @(lease.TenantSigned ? "‚úì Ng∆∞·ªùi thu√™" : "‚è≥ Ng∆∞·ªùi thu√™")
                                    </span>
                                </div>
                            </td>
                            <td class="text-green fw-600">@lease.MonthlyRent.ToString("N0") ƒë</td>
                            <td class="text-muted">
                                <div style="font-size: 12px;">@lease.StartDate.ToString("dd/MM/yyyy")</div>
                                <div style="font-size: 12px;">‚Üí @lease.EndDate.ToString("dd/MM/yyyy")</div>
                            </td>
                            <td>
                                <div style="display: flex; gap: 6px;">
                                    @{ var lJson = System.Text.Json.JsonSerializer.Serialize(lease); }
                                    <button class="btn btn-ghost btn-sm" onclick="openDetailModal(@lJson)"><i data-feather="eye" style="width: 13px;"></i> Chi ti·∫øt</button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-icon">üìÑ</div>
                                <p>B·∫°n ch∆∞a c√≥ h·ª£p ƒë·ªìng thu√™ n√†o.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- H·ª£p ƒë·ªìng Detail Modal -->
<div class="modal-overlay" id="detailModal" style="display: none;" onclick="closeModals()">
    <div class="modal" style="max-width: 800px;" onclick="event.stopPropagation()">
        <div class="modal-header">
            <span class="modal-title" id="dtLeaseTitle">H·ª£p ƒë·ªìng</span>
            <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" style="border: none;" onclick="closeModals()"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding: 16px; background: var(--bg-primary); border-radius: 8px;">
                <div>
                    <div class="fw-700" style="font-size: 18px; color: var(--accent-light);" id="dtLeaseNumber"></div>
                    <div class="text-muted text-sm" id="dtCreatedAt"></div>
                </div>
                <div id="dtStatusBadge"></div>
            </div>
            <div class="grid-2">
                <div>
                    <div class="info-row"><span class="info-label">BDS</span><span class="info-value" id="dtPropertyTitle"></span></div>
                    <div class="info-row"><span class="info-label">ƒê·ªãa ch·ªâ</span><span class="info-value text-sm" id="dtPropertyAddress"></span></div>
                    <div class="info-row"><span class="info-label">Ch·ªß nh√†</span><span class="info-value" id="dtLandlordName"></span></div>
                    <div class="info-row"><span class="info-label">Ng∆∞·ªùi thu√™</span><span class="info-value" id="dtTenantName"></span></div>
                </div>
                <div>
                    <div class="info-row"><span class="info-label">Ti·ªÅn thu√™/th√°ng</span><span class="info-value text-green fw-700" id="dtRent"></span></div>
                    <div class="info-row"><span class="info-label">ƒê·∫∑t c·ªçc</span><span class="info-value" id="dtDeposit"></span></div>
                    <div class="info-row"><span class="info-label">Ng√†y thanh to√°n</span><span class="info-value" id="dtPaymentDay"></span></div>
                    <div class="info-row"><span class="info-label">Ph√≠ tr·ªÖ h·∫°n</span><span class="info-value" id="dtLateFee"></span></div>
                </div>
            </div>
            <div class="info-row"><span class="info-label">Ng√†y b·∫Øt ƒë·∫ßu</span><span class="info-value" id="dtStartDate"></span></div>
            <div class="info-row"><span class="info-label">Ng√†y k·∫øt th√∫c</span><span class="info-value" id="dtEndDate"></span></div>
            
            <div id="dtTermsGroup" style="display: none;">
                <div class="info-row"><span class="info-label">ƒêi·ªÅu kho·∫£n</span><span class="info-value text-sm" id="dtTerms" style="white-space: pre-wrap;"></span></div>
            </div>
            <div id="dtSpecialGroup" style="display: none;">
                <div class="info-row"><span class="info-label">ƒêi·ªÅu kho·∫£n ƒë·∫∑c bi·ªát</span><span class="info-value text-sm" id="dtSpecial" style="white-space: pre-wrap;"></span></div>
            </div>

            <div class="mb-16 mt-16" style="padding: 14px; background: var(--bg-primary); border-radius: 8px;">
                <div class="fw-600 mb-8" style="font-size: 13px;">T√¨nh tr·∫°ng ch·ªØ k√Ω</div>
                <div style="display: flex; gap: 12px;">
                    <div id="dtSignLandlordBox" style="flex: 1; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                        <div style="font-size: 20px; margin-bottom: 4px;" id="dtSignLandlordIcon">‚è≥</div>
                        <div class="fw-600" style="font-size: 12px;">Ch·ªß nh√†</div>
                        <div class="text-muted text-sm" id="dtSignLandlordDate">Ch∆∞a k√Ω</div>
                    </div>
                    <div id="dtSignTenantBox" style="flex: 1; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                        <div style="font-size: 20px; margin-bottom: 4px;" id="dtSignTenantIcon">‚è≥</div>
                        <div class="fw-600" style="font-size: 12px;">Ng∆∞·ªùi thu√™</div>
                        <div class="text-muted text-sm" id="dtSignTenantDate">Ch∆∞a k√Ω</div>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer" id="dtFooterBtns" style="justify-content: flex-end; gap: 8px;">
            <button type="button" class="btn btn-secondary" onclick="closeModals()">ƒê√≥ng</button>
            <form method="post" asp-page-handler="Sign" id="signForm" style="margin:0; display:none;">
                <input type="hidden" name="leaseId" id="signLeaseId" value="" />
                <button type="button" class="btn btn-primary" onclick="confirmSignBtn()">K√Ω H·ª£p ƒê·ªìng</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function setFilter(status) {
            document.getElementById('statusFilter').value = status;
            document.getElementById('filterForm').submit();
        }

        function closeModals() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function openDetailModal(lease) {
            closeModals();
            document.getElementById('dtLeaseTitle').textContent = `H·ª£p ƒë·ªìng ${lease.LeaseNumber}`;
            document.getElementById('dtLeaseNumber').textContent = lease.LeaseNumber;
            document.getElementById('dtCreatedAt').textContent = 'T·∫°o ng√†y ' + new Date(lease.CreatedAt).toLocaleDateString('vi-VN');
            
            let statusBadge = '<span class="badge badge-gray">Kh√°c</span>';
            if(lease.Status === 1) statusBadge = '<span class="badge badge-success">Hi·ªáu l·ª±c</span>';
            else if(lease.Status === 2) statusBadge = '<span class="badge badge-gray">H·∫øt h·∫°n</span>';
            else if(lease.Status === 3) statusBadge = '<span class="badge badge-danger">Ch·∫•m d·ª©t</span>';
            else if(lease.Status === 4) statusBadge = '<span class="badge badge-warning">Ch·ªù k√Ω</span>';
            document.getElementById('dtStatusBadge').innerHTML = statusBadge;

            document.getElementById('dtPropertyTitle').textContent = lease.PropertyTitle;
            document.getElementById('dtPropertyAddress').textContent = lease.PropertyAddress || 'N/A';
            document.getElementById('dtLandlordName').textContent = lease.LandlordName;
            document.getElementById('dtTenantName').textContent = lease.TenantName;
            
            document.getElementById('dtRent').textContent = new Intl.NumberFormat('vi-VN').format(lease.MonthlyRent) + ' ƒë';
            document.getElementById('dtDeposit').textContent = new Intl.NumberFormat('vi-VN').format(lease.DepositAmount) + ' ƒë';
            document.getElementById('dtPaymentDay').textContent = `Ng√†y ${lease.PaymentDueDay} h√†ng th√°ng`;
            document.getElementById('dtLateFee').textContent = lease.LateFeePercentage ? `${lease.LateFeePercentage}%/th√°ng` : '0%/th√°ng';

            document.getElementById('dtStartDate').textContent = new Date(lease.StartDate).toLocaleDateString('vi-VN');
            document.getElementById('dtEndDate').textContent = new Date(lease.EndDate).toLocaleDateString('vi-VN');

            if(lease.Terms) {
                document.getElementById('dtTermsGroup').style.display = 'block';
                document.getElementById('dtTerms').textContent = lease.Terms;
            } else { document.getElementById('dtTermsGroup').style.display = 'none'; }
            
            if(lease.SpecialConditions) {
                document.getElementById('dtSpecialGroup').style.display = 'block';
                document.getElementById('dtSpecial').textContent = lease.SpecialConditions;
            } else { document.getElementById('dtSpecialGroup').style.display = 'none'; }

            const llBox = document.getElementById('dtSignLandlordBox');
            if(lease.LandlordSigned) {
                llBox.style.borderColor = 'var(--success)';
                document.getElementById('dtSignLandlordIcon').textContent = '‚úÖ';
                document.getElementById('dtSignLandlordDate').textContent = lease.LandlordSignedAt ? new Date(lease.LandlordSignedAt).toLocaleDateString('vi-VN') : 'ƒê√£ k√Ω';
            } else {
                llBox.style.borderColor = 'var(--border)';
                document.getElementById('dtSignLandlordIcon').textContent = '‚è≥';
                document.getElementById('dtSignLandlordDate').textContent = 'Ch∆∞a k√Ω';
            }

            const tBox = document.getElementById('dtSignTenantBox');
            if(lease.TenantSigned) {
                tBox.style.borderColor = 'var(--success)';
                document.getElementById('dtSignTenantIcon').textContent = '‚úÖ';
                document.getElementById('dtSignTenantDate').textContent = lease.TenantSignedAt ? new Date(lease.TenantSignedAt).toLocaleDateString('vi-VN') : 'ƒê√£ k√Ω';
            } else {
                tBox.style.borderColor = 'var(--border)';
                document.getElementById('dtSignTenantIcon').textContent = '‚è≥';
                document.getElementById('dtSignTenantDate').textContent = 'Ch∆∞a k√Ω';
            }

            const signForm = document.getElementById('signForm');
            if (lease.Status === 4 /* Pending */ && !lease.TenantSigned) {
                signForm.style.display = 'block';
                document.getElementById('signLeaseId').value = lease.Id;
            } else {
                signForm.style.display = 'none';
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function confirmSignBtn() {
            Swal.fire({
                title: 'X√°c nh·∫≠n k√Ω h·ª£p ƒë·ªìng',
                text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n v√† k√Ω h·ª£p ƒë·ªìng n√†y kh√¥ng?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'C√≥, K√Ω ngay!',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('signForm').submit();
                }
            });
        }
    </script>
}
