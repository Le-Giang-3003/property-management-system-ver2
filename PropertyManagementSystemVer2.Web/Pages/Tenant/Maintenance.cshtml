@page
@model PropertyManagementSystemVer2.Web.Pages.Tenant.MaintenanceModel
@{
    ViewData["Title"] = "Y√™u c·∫ßu b·∫£o tr√¨";
}

<div class="mb-20" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
        <div class="page-title">Y√™u c·∫ßu b·∫£o tr√¨</div>
        <div class="page-desc">B√°o c√°o s∆∞ c·ªë v√† theo d√µi ti·∫øn ƒë·ªô s·ª≠a ch·ªØa</div>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i data-feather="plus" style="width: 16px;"></i> T·∫°o y√™u c·∫ßu m·ªõi
    </button>
</div>

<div class="card mb-16" style="padding: 16px;">
    <div class="admin-search-wrapper" style="margin: 0;">
        <i data-feather="search" class="admin-search-icon"></i>
        <input type="text" id="searchInput" class="admin-search-input" placeholder="T√¨m ti√™u ƒë·ªÅ, b·∫•t ƒë·ªông s·∫£n..." onkeyup="filterRequests()" />
    </div>
</div>

<div class="filter-bar">
    <button class="btn btn-primary btn-sm filter-btn" data-status="All" onclick="setStatusFilter('All', this)">T·∫•t c·∫£</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="InProgress" onclick="setStatusFilter('InProgress', this)">ƒêang x·ª≠ l√Ω</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="Open" onclick="setStatusFilter('Open', this)">ƒêang ch·ªù</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="Resolved" onclick="setStatusFilter('Resolved', this)">ƒê√£ xong</button>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>TI√äU ƒê·ªÄ / B·∫§T ƒê·ªòNG S·∫¢N</th>
                    <th>NG√ÄY Y√äU C·∫¶U</th>
                    <th>M·ª®C ƒê·ªò</th>
                    <th>DANH M·ª§C</th>
                    <th>TR·∫†NG TH√ÅI</th>
                    <th>H√ÄNH ƒê·ªòNG</th>
                </tr>
            </thead>
            <tbody id="maintenanceTableBody">
                @if (Model.MaintenanceRequests != null && Model.MaintenanceRequests.Any())
                {
                    foreach (var req in Model.MaintenanceRequests)
                    {
                        <tr class="maintenance-row" data-search="@req.Title.ToLower() @req.PropertyTitle.ToLower()" data-status="@req.Status">
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <strong style="font-size: 13px; color: var(--text-primary);">@req.Title</strong>
                                    <span style="font-size: 11px; color: var(--text-muted);">@req.PropertyTitle</span>
                                </div>
                            </td>
                            <td class="text-muted">@req.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                @if (req.Priority.ToString() == "Urgent" || req.Priority.ToString() == "Critical")
                                {
                                    <span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">Kh·∫©n c·∫•p</span>
                                }
                                else if (req.Priority.ToString() == "High")
                                {
                                    <span class="badge" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">Cao</span>
                                }
                                else if (req.Priority.ToString() == "Medium")
                                {
                                    <span class="badge badge-info">Trung b√¨nh</span>
                                }
                                else
                                {
                                    <span class="badge badge-success">Th·∫•p</span>
                                }
                            </td>
                            <td>
                                @{
                                    var categoryLabel = req.Category.ToString() switch
                                    {
                                        "Plumbing" => "·ªêng n∆∞·ªõc",
                                        "Electrical" => "ƒêi·ªán",
                                        "Appliance" => "Gia d·ª•ng",
                                        "Structural" => "C·∫•u tr√∫c/X√¢y d·ª±ng",
                                        "Other" => "Kh√°c",
                                        _ => req.Category.ToString()
                                    };
                                }
                                <span class="badge badge-gray">@categoryLabel</span>
                            </td>
                            <td>
                                @if (req.Status.ToString() == "Open")
                                {
                                    <span class="badge badge-warning">ƒêang ch·ªù</span>
                                }
                                else if (req.Status.ToString() == "InProgress")
                                {
                                    <span class="badge badge-info">ƒêang x·ª≠ l√Ω</span>
                                }
                                else if (req.Status.ToString() == "Resolved")
                                {
                                    <span class="badge badge-success">ƒê√£ xong</span>
                                }
                                else if (req.Status.ToString() == "Cancelled")
                                {
                                    <span class="badge badge-danger">ƒê√£ h·ªßy</span>
                                }
                                else
                                {
                                    <span class="badge badge-gray">@req.Status</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-ghost btn-sm btn-icon" onclick="openDetailModal(@req.Id)" title="Xem chi ti·∫øt" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                    <i data-feather="eye" style="width: 16px;"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-icon">tool</div>
                                <p>B·∫°n ch∆∞a c√≥ y√™u c·∫ßu b·∫£o tr√¨ n√†o.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- CREATE MODAL -->
<div id="createModal" class="modal-overlay" style="display: none;">
    <div class="modal custom-modal" style="width: 600px;">
        <form method="post" asp-page-handler="Create" id="createForm" enctype="multipart/form-data">
            <div class="modal-header">
                <span class="modal-title">G·ª≠i y√™u c·∫ßu b·∫£o tr√¨ m·ªõi</span>
                <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('createModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Ch·ªçn b·∫•t ƒë·ªông s·∫£n *</label>
                    <select name="leaseId" id="leaseSelect" class="form-control" required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;" onchange="updatePropertyId()">
                        <option value="">-- Ch·ªçn BDS ƒëang thu√™ --</option>
                        @foreach (var lease in Model.ActiveLeases)
                        {
                            <option value="@lease.Id" data-propertyid="@lease.PropertyId">@lease.PropertyTitle - @lease.PropertyAddress</option>
                        }
                    </select>
                    <input type="hidden" name="propertyId" id="propertyIdInput" />
                    @if (!Model.ActiveLeases.Any())
                    {
                        <div style="margin-top: 8px; font-size: 12px; color: var(--danger); display: flex; align-items: center; gap: 6px;">
                            <i data-feather="alert-circle" style="width: 14px;"></i>
                            <span>B·∫°n ch∆∞a c√≥ h·ª£p ƒë·ªìng thu√™ n√†o ƒëang hi·ªáu l·ª±c</span>
                        </div>
                    }
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Ti√™u ƒë·ªÅ *</label>
                    <input name="title" class="form-control" placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn s·ª± c·ªë..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;" />
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Danh m·ª•c</label>
                        <select name="category" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="Plumbing">H·ªá th·ªëng n∆∞·ªõc</option>
                            <option value="Electrical">H·ªá th·ªëng ƒëi·ªán</option>
                            <option value="Appliance">Thi·∫øt b·ªã gia d·ª•ng</option>
                            <option value="Structural">K·∫øt c·∫•u & X√¢y d·ª±ng</option>
                            <option value="Other">Kh√°c</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">M·ª©c ƒë·ªô ∆∞u ti√™n</label>
                        <select name="priority" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="Low">Th·∫•p</option>
                            <option value="Medium" selected>Trung b√¨nh</option>
                            <option value="High">Cao</option>
                            <option value="Urgent">Kh·∫©n c·∫•p</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">M√¥ t·∫£ chi ti·∫øt *</label>
                    <textarea name="description" class="form-control" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt s·ª± c·ªë, v·ªã tr√≠, th·ªùi gian ph√°t hi·ªán..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        <i data-feather="image" style="width: 14px; margin-right: 4px;"></i>H√¨nh ·∫£nh minh h·ªça
                    </label>
                    <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 24px; text-align: center; background: var(--bg-hover); cursor: pointer; position: relative;" onclick="document.getElementById('file-upload').click()">
                        <input id="file-upload" name="files" type="file" multiple accept="image/*" onchange="handleImageUpload(event)" style="display: none;" />
                        <div style="color: var(--text-muted); margin: 0 auto 12px; display: flex; justify-content: center;"><i data-feather="upload" style="width: 32px; height: 32px;"></i></div>
                        <div style="color: var(--text-primary); margin-bottom: 4px; font-weight: 500;">Click ƒë·ªÉ t·∫£i ·∫£nh l√™n</div>
                        <div style="color: var(--text-muted); font-size: 12px;">H·ªó tr·ª£ JPG, PNG (T·ªëi ƒëa 5MB m·ªói ·∫£nh)</div>
                    </div>
                    
                    <div id="image-preview-container" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="confirmCreate()">G·ª≠i y√™u c·∫ßu</button>
            </div>
        </form>
    </div>
</div>

@if (Model.MaintenanceRequests != null)
{
    foreach (var req in Model.MaintenanceRequests)
    {
        <!-- DETAIL MODAL -->
        <div id="detailModal-@req.Id" class="modal-overlay" style="display: none;">
            <div class="modal custom-modal" style="width: 680px; max-width: 95vw;">
                <div class="modal-header">
                    <span class="modal-title">
                        <span style="color: var(--text-muted); font-size: 12px; margin-right: 6px;">#@req.Id</span>
                        @req.Title
                    </span>
                    <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('detailModal-@req.Id')">‚úï</button>
                </div>
                <div class="modal-body" style="padding: 20px;">

                    <!-- ‚îÄ‚îÄ Status + Priority + Category badges ‚îÄ‚îÄ -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                        @if (req.Status.ToString() == "Open")
                        { <span class="badge badge-warning">‚è≥ ƒêang ch·ªù</span> }
                        else if (req.Status.ToString() == "InProgress")
                        { <span class="badge badge-info">üîß ƒêang x·ª≠ l√Ω</span> }
                        else if (req.Status.ToString() == "Resolved")
                        { <span class="badge badge-success">‚úÖ ƒê√£ xong</span> }
                        else if (req.Status.ToString() == "Cancelled")
                        { <span class="badge badge-danger">‚ùå ƒê√£ h·ªßy</span> }

                        @if (req.Priority.ToString() is "Urgent" or "Critical")
                        { <span class="badge" style="background:rgba(239,68,68,.15);color:var(--danger);">üî¥ Kh·∫©n c·∫•p</span> }
                        else if (req.Priority.ToString() == "High")
                        { <span class="badge" style="background:rgba(245,158,11,.15);color:var(--warning);">üü† Cao</span> }
                        else if (req.Priority.ToString() == "Medium")
                        { <span class="badge badge-info">üü° Trung b√¨nh</span> }
                        else
                        { <span class="badge badge-success">üü¢ Th·∫•p</span> }

                        @{
                            var detailCat = req.Category.ToString() switch
                            {
                                "Plumbing"   => "ü™† ·ªêng n∆∞·ªõc",
                                "Electrical" => "‚ö° ƒêi·ªán",
                                "Appliance"  => "üè† Gia d·ª•ng",
                                "Structural" => "üèóÔ∏è C·∫•u tr√∫c",
                                "Painting"   => "üé® S∆°n",
                                "Cleaning"   => "üßπ V·ªá sinh",
                                _            => req.Category.ToString()
                            };
                        }
                        <span class="badge badge-gray">@detailCat</span>
                    </div>

                    <!-- ‚îÄ‚îÄ Th√¥ng tin ch√≠nh ‚îÄ‚îÄ -->
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:16px; margin-bottom:14px;">

                        <!-- BƒêS + Ng∆∞·ªùi y√™u c·∫ßu -->
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed var(--border);">
                            <div>
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;">üè¢ B·∫•t ƒë·ªông s·∫£n</div>
                                <div style="font-weight:600; font-size:13px;">@req.PropertyTitle</div>
                            </div>
                            <div>
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;">üë§ Ng∆∞·ªùi y√™u c·∫ßu</div>
                                <div style="font-weight:600; font-size:13px;">@req.RequesterName</div>
                                @if (!string.IsNullOrEmpty(req.RequesterPhone))
                                {
                                    <div style="font-size:12px; color:var(--text-muted); margin-top:2px;">üìû @req.RequesterPhone</div>
                                }
                            </div>
                        </div>

                        <!-- Ng√†y t·∫°o + Ng√†y h·∫πn + Ng√†y xong -->
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px,1fr)); gap:10px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px dashed var(--border);">
                            <div>
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;">üìÖ Ng√†y t·∫°o</div>
                                <div style="font-weight:600; font-size:13px;">@req.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                            @if (req.ScheduledDate.HasValue)
                            {
                                <div>
                                    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;">üóìÔ∏è Ng√†y h·∫πn</div>
                                    <div style="font-weight:600; font-size:13px; color:#60a5fa;">@req.ScheduledDate.Value.ToString("dd/MM/yyyy")</div>
                                </div>
                            }
                            @if (req.ResolvedAt.HasValue)
                            {
                                <div>
                                    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;">‚úÖ Ng√†y xong</div>
                                    <div style="font-weight:600; font-size:13px; color:#34d399;">@req.ResolvedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                                </div>
                            }
                        </div>

                        <!-- M√¥ t·∫£ -->
                        <div style="margin-bottom: 0;">
                            <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:6px;">üìù M√¥ t·∫£ chi ti·∫øt</div>
                            <div style="font-size:14px; line-height:1.6; white-space:pre-wrap;">@req.Description</div>
                        </div>
                    </div>

                    <!-- ‚îÄ‚îÄ Th√¥ng tin k·ªπ thu·∫≠t vi√™n (khi InProgress) ‚îÄ‚îÄ -->
                    @if (!string.IsNullOrEmpty(req.TechnicianName))
                    {
                        <div style="background:rgba(16,185,129,.1); border:2px solid #10b981; border-radius:10px; padding:14px; margin-bottom:14px;">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                                <i data-feather="user-check" style="width:16px; color:#10b981;"></i>
                                <span style="font-size:11px; font-weight:700; text-transform:uppercase; color:#10b981; letter-spacing:.5px;">ƒê√£ k√™u th·ª£</span>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div>
                                    <div style="font-size:11px; color:#34d399; margin-bottom:3px;">T√™n k·ªπ thu·∫≠t vi√™n</div>
                                    <div style="font-weight:700; font-size:14px; color:#f1f5f9;">@req.TechnicianName</div>
                                </div>
                                <div>
                                    <div style="font-size:11px; color:#34d399; margin-bottom:3px;">S·ªë ƒëi·ªán tho·∫°i</div>
                                    <div style="font-weight:700; font-size:14px; color:#f1f5f9;">@req.TechnicianPhone</div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- ‚îÄ‚îÄ L√Ω do t·ª´ ch·ªëi (khi Cancelled) ‚îÄ‚îÄ -->
                    @if (!string.IsNullOrEmpty(req.RejectionReason))
                    {
                        <div style="background:rgba(239,68,68,.1); border:2px solid #ef4444; border-radius:10px; padding:14px; margin-bottom:14px;">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                                <i data-feather="x-circle" style="width:16px; color:#ef4444;"></i>
                                <span style="font-size:11px; font-weight:700; text-transform:uppercase; color:#ef4444; letter-spacing:.5px;">L√Ω do t·ª´ ch·ªëi / H·ªßy</span>
                            </div>
                            <div style="font-size:14px; line-height:1.6; color:#fca5a5; white-space:pre-wrap;">@req.RejectionReason</div>
                        </div>
                    }

                    <!-- ‚îÄ‚îÄ K·∫øt qu·∫£ x·ª≠ l√Ω (Resolution) ‚îÄ‚îÄ -->
                    @if (!string.IsNullOrEmpty(req.Resolution))
                    {
                        <div style="background:rgba(99,102,241,.1); border:1px solid rgba(99,102,241,.4); border-radius:10px; padding:14px; margin-bottom:14px;">
                            <div style="font-size:11px; color:#818cf8; text-transform:uppercase; letter-spacing:.5px; margin-bottom:6px;">üìã K·∫øt qu·∫£ x·ª≠ l√Ω</div>
                            <div style="font-size:14px; line-height:1.6; white-space:pre-wrap; color:#e2e8f0;">@req.Resolution</div>
                        </div>
                    }

                    <!-- ‚îÄ‚îÄ H√¨nh ·∫£nh ‚îÄ‚îÄ -->
                    @if (!string.IsNullOrEmpty(req.ImageUrls))
                    {
                        var images = req.ImageUrls.Split(',').Select(u => u.Trim()).Where(u => !string.IsNullOrEmpty(u)).ToArray();
                        if (images.Length > 0)
                        {
                            <div>
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                                    <i data-feather="image" style="width:15px; color:var(--text-muted);"></i>
                                    <span style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; font-weight:600;">H√¨nh ·∫£nh ƒë√≠nh k√®m (@images.Length ·∫£nh)</span>
                                </div>
                                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:8px;">
                                    @foreach (var img in images)
                                    {
                                        var trimmedImg = img.Trim();
                                        <div style="position:relative; border-radius:8px; overflow:hidden; padding-top:100%; border:2px solid var(--border); background:var(--bg-hover);">
                                            <a href="@trimmedImg" target="_blank" style="position:absolute; top:0; left:0; width:100%; height:100%;">
                                                <img src="@trimmedImg" alt="·∫¢nh ƒë√≠nh k√®m"
                                                     style="width:100%; height:100%; object-fit:cover; transition:opacity .2s;"
                                                     onerror="this.style.display='none'; this.parentElement.innerHTML += '<div style=\'display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:11px;\'>L·ªói t·∫£i ·∫£nh</div>';" />
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }

                </div><!-- end modal-body -->
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('detailModal-@req.Id')">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            @if(TempData["SuccessMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng',
                    text: '@Html.Raw(TempData["SuccessMessage"])',
                    confirmButtonColor: '#3085d6'
                });
                </text>
            }
            @if(TempData["ErrorMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: '@Html.Raw(TempData["ErrorMessage"])',
                    confirmButtonColor: '#d33'
                });
                </text>
            }
        });

        function filterRequests() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            var activeStatus = document.querySelector('.filter-btn.btn-primary').getAttribute('data-status');
            
            var rows = document.querySelectorAll('.maintenance-row');
            rows.forEach(function(row) {
                var text = row.getAttribute('data-search');
                var status = row.getAttribute('data-status');
                
                var matchSearch = search === "" || text.includes(search);
                var matchStatus = activeStatus === "All" || status === activeStatus;
                
                if (matchSearch && matchStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function setStatusFilter(status, btn) {
            document.querySelectorAll('.filter-btn').forEach(function(b) {
                b.classList.remove('btn-primary');
                b.classList.add('btn-ghost');
            });
            btn.classList.remove('btn-ghost');
            btn.classList.add('btn-primary');
            filterRequests();
        }

        function openDetailModal(id) {
            document.getElementById('detailModal-' + id).style.display = 'flex';
        }

        function openCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function updatePropertyId() {
            var select = document.getElementById('leaseSelect');
            var selectedOption = select.options[select.selectedIndex];
            var propId = selectedOption.getAttribute('data-propertyid');
            document.getElementById('propertyIdInput').value = propId;
        }

        function confirmCreate() {
            var form = document.getElementById('createForm');
            if(form.reportValidity()) {
                updatePropertyId();
                if(document.getElementById('propertyIdInput').value === "") {
                    Swal.fire('L·ªói', 'Vui l√≤ng ch·ªçn b·∫•t ƒë·ªông s·∫£n h·ª£p l·ªá', 'error');
                    return;
                }
                
                Swal.fire({
                    title: 'X√°c nh·∫≠n g·ª≠i y√™u c·∫ßu?',
                    text: "Ch·ªß nh√† s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ s·ª± c·ªë n√†y",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'G·ª≠i',
                    cancelButtonText: 'H·ªßy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            }
        }

        function handleImageUpload(event) {
            var files = event.target.files;
            var container = document.getElementById('image-preview-container');
            
            if (files.length > 0) {
                container.style.display = 'grid';
                container.innerHTML = ''; // Clear old preview
                
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    if (file.type.match('image.*')) {
                        var reader = new FileReader();
                        reader.onload = (function(f) {
                            return function(e) {
                                var div = document.createElement('div');
                                div.style.position = 'relative';
                                div.style.borderRadius = '6px';
                                div.style.overflow = 'hidden';
                                div.style.paddingTop = '100%';
                                div.style.border = '1px solid var(--border)';
                                
                                var img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.position = 'absolute';
                                img.style.top = '0';
                                img.style.left = '0';
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                
                                div.appendChild(img);
                                container.appendChild(div);
                            };
                        })(file);
                        reader.readAsDataURL(file);
                    }
                }
            } else {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
    </script>
}
