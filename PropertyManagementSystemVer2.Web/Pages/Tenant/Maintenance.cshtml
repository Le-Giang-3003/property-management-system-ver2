@page
@model PropertyManagementSystemVer2.Web.Pages.Tenant.MaintenanceModel
@{
    ViewData["Title"] = "Yêu cầu bảo trì";
}

<div class="mb-20" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
        <div class="page-title">Yêu cầu bảo trì</div>
        <div class="page-desc">Báo cáo sư cố và theo dõi tiến độ sửa chữa</div>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i data-feather="plus" style="width: 16px;"></i> Tạo yêu cầu mới
    </button>
</div>

<div class="card mb-16" style="padding: 16px;">
    <div class="admin-search-wrapper" style="margin: 0;">
        <i data-feather="search" class="admin-search-icon"></i>
        <input type="text" id="searchInput" class="admin-search-input" placeholder="Tìm tiêu đề, bất động sản..." onkeyup="filterRequests()" />
    </div>
</div>

<div class="filter-bar">
    <button class="btn btn-primary btn-sm filter-btn" data-status="All" onclick="setStatusFilter('All', this)">Tất cả</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="InProgress" onclick="setStatusFilter('InProgress', this)">Đang xử lý</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="Open" onclick="setStatusFilter('Open', this)">Đang chờ</button>
    <button class="btn btn-ghost btn-sm filter-btn" data-status="Resolved" onclick="setStatusFilter('Resolved', this)">Đã xong</button>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>TIÊU ĐỀ / BẤT ĐỘNG SẢN</th>
                    <th>NGÀY YÊU CẦU</th>
                    <th>MỨC ĐỘ</th>
                    <th>DANH MỤC</th>
                    <th>TRẠNG THÁI</th>
                    <th>HÀNH ĐỘNG</th>
                </tr>
            </thead>
            <tbody id="maintenanceTableBody">
                @if (Model.MaintenanceRequests != null && Model.MaintenanceRequests.Any())
                {
                    foreach (var req in Model.MaintenanceRequests)
                    {
                        <tr class="maintenance-row" data-search="@req.Title.ToLower() @req.PropertyTitle.ToLower()" data-status="@req.Status">
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <strong style="font-size: 13px; color: var(--text-primary);">@req.Title</strong>
                                    <span style="font-size: 11px; color: var(--text-muted);">@req.PropertyTitle</span>
                                </div>
                            </td>
                            <td class="text-muted">@req.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                @if (req.Priority.ToString() == "Urgent" || req.Priority.ToString() == "Critical")
                                {
                                    <span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">Khẩn cấp</span>
                                }
                                else if (req.Priority.ToString() == "High")
                                {
                                    <span class="badge" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">Cao</span>
                                }
                                else if (req.Priority.ToString() == "Medium")
                                {
                                    <span class="badge badge-info">Trung bình</span>
                                }
                                else
                                {
                                    <span class="badge badge-success">Thấp</span>
                                }
                            </td>
                            <td>
                                @{
                                    var categoryLabel = req.Category.ToString() switch
                                    {
                                        "Plumbing" => "Ống nước",
                                        "Electrical" => "Điện",
                                        "Appliance" => "Gia dụng",
                                        "Structural" => "Cấu trúc/Xây dựng",
                                        "Other" => "Khác",
                                        _ => req.Category.ToString()
                                    };
                                }
                                <span class="badge badge-gray">@categoryLabel</span>
                            </td>
                            <td>
                                @if (req.Status.ToString() == "Open")
                                {
                                    <span class="badge badge-warning">Đang chờ</span>
                                }
                                else if (req.Status.ToString() == "InProgress")
                                {
                                    <span class="badge badge-info">Đang xử lý</span>
                                }
                                else if (req.Status.ToString() == "Resolved")
                                {
                                    <span class="badge badge-success">Đã xong</span>
                                }
                                else if (req.Status.ToString() == "Cancelled")
                                {
                                    <span class="badge badge-danger">Đã hủy</span>
                                }
                                else
                                {
                                    <span class="badge badge-gray">@req.Status</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-ghost btn-sm btn-icon" onclick="openDetailModal(@req.Id)" title="Xem chi tiết" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                    <i data-feather="eye" style="width: 16px;"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-icon">tool</div>
                                <p>Bạn chưa có yêu cầu bảo trì nào.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- CREATE MODAL -->
<div id="createModal" class="modal-overlay" style="display: none;">
    <div class="modal custom-modal" style="width: 600px;">
        <form method="post" asp-page-handler="Create" id="createForm" enctype="multipart/form-data">
            <div class="modal-header">
                <span class="modal-title">Gửi yêu cầu bảo trì mới</span>
                <button type="button" class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('createModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Chọn bất động sản *</label>
                    <select name="leaseId" id="leaseSelect" class="form-control" required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;" onchange="updatePropertyId()">
                        <option value="">-- Chọn BDS đang thuê --</option>
                        @foreach (var lease in Model.ActiveLeases)
                        {
                            <option value="@lease.Id" data-propertyid="@lease.PropertyId">@lease.PropertyTitle - @lease.PropertyAddress</option>
                        }
                    </select>
                    <input type="hidden" name="propertyId" id="propertyIdInput" />
                    @if (!Model.ActiveLeases.Any())
                    {
                        <div style="margin-top: 8px; font-size: 12px; color: var(--danger); display: flex; align-items: center; gap: 6px;">
                            <i data-feather="alert-circle" style="width: 14px;"></i>
                            <span>Bạn chưa có hợp đồng thuê nào đang hiệu lực</span>
                        </div>
                    }
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Tiêu đề *</label>
                    <input name="title" class="form-control" placeholder="Mô tả ngắn gọn sự cố..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;" />
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Danh mục</label>
                        <select name="category" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="Plumbing">Hệ thống nước</option>
                            <option value="Electrical">Hệ thống điện</option>
                            <option value="Appliance">Thiết bị gia dụng</option>
                            <option value="Structural">Kết cấu & Xây dựng</option>
                            <option value="Other">Khác</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Mức độ ưu tiên</label>
                        <select name="priority" class="form-control" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="Low">Thấp</option>
                            <option value="Medium" selected>Trung bình</option>
                            <option value="High">Cao</option>
                            <option value="Urgent">Khẩn cấp</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">Mô tả chi tiết *</label>
                    <textarea name="description" class="form-control" rows="4" placeholder="Mô tả chi tiết sự cố, vị trí, thời gian phát hiện..." required style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        <i data-feather="image" style="width: 14px; margin-right: 4px;"></i>Hình ảnh minh họa
                    </label>
                    <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 24px; text-align: center; background: var(--bg-hover); cursor: pointer; position: relative;" onclick="document.getElementById('file-upload').click()">
                        <input id="file-upload" name="files" type="file" multiple accept="image/*" onchange="handleImageUpload(event)" style="display: none;" />
                        <div style="color: var(--text-muted); margin: 0 auto 12px; display: flex; justify-content: center;"><i data-feather="upload" style="width: 32px; height: 32px;"></i></div>
                        <div style="color: var(--text-primary); margin-bottom: 4px; font-weight: 500;">Click để tải ảnh lên</div>
                        <div style="color: var(--text-muted); font-size: 12px;">Hỗ trợ JPG, PNG (Tối đa 5MB mỗi ảnh)</div>
                    </div>
                    
                    <div id="image-preview-container" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="confirmCreate()">Gửi yêu cầu</button>
            </div>
        </form>
    </div>
</div>

@if (Model.MaintenanceRequests != null)
{
    foreach (var req in Model.MaintenanceRequests)
    {
        <!-- DETAIL MODAL -->
        <div id="detailModal-@req.Id" class="modal-overlay" style="display: none;">
            <div class="modal custom-modal" style="width: 600px;">
                <div class="modal-header">
                    <span class="modal-title">#@req.Id - @req.Title</span>
                    <button class="modal-close btn btn-ghost btn-sm btn-icon" onclick="closeModal('detailModal-@req.Id')">✕</button>
                </div>
                <div class="modal-body" style="background-color: var(--bg-hover); padding: 20px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        @if (req.Status.ToString() == "Open")
                        {
                            <span class="badge badge-warning">Đang chờ</span>
                        }
                        else if (req.Status.ToString() == "InProgress")
                        {
                            <span class="badge badge-info">Đang xử lý</span>
                        }
                        else if (req.Status.ToString() == "Resolved")
                        {
                            <span class="badge badge-success">Đã xong</span>
                        }
                        else if (req.Status.ToString() == "Cancelled")
                        {
                            <span class="badge badge-danger">Đã hủy</span>
                        }
                        else
                        {
                            <span class="badge badge-gray">@req.Status</span>
                        }
                        @{
                            var badgeCategoryLabel = req.Category.ToString() switch
                            {
                                "Plumbing" => "Ống nước",
                                "Electrical" => "Điện",
                                "Appliance" => "Gia dụng",
                                "Structural" => "Cấu trúc/Xây dựng",
                                "Other" => "Khác",
                                _ => req.Category.ToString()
                            };
                        }
                        <span class="badge badge-gray">@badgeCategoryLabel</span>
                    </div>
                    
                    <div style="background-color: var(--bg-card); border-radius: 8px; padding: 16px; border: 1px solid var(--border);">
                        <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">BDS</span>
                            <span class="info-value" style="font-weight: 500;">@req.PropertyTitle</span>
                        </div>
                        <div class="info-row" style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Mô tả chi tiết</span>
                            <span class="info-value" style="white-space: pre-wrap; font-size: 14px;">@req.Description</span>
                        </div>
                        <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                            <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Ngày tạo</span>
                            <span class="info-value" style="font-weight: 500;">@req.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>

                        @if (!string.IsNullOrEmpty(req.Resolution))
                        {
                            <div class="info-row" style="display: flex; flex-direction: column; gap: 4px; border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 12px;">
                                <span class="info-label" style="color: var(--text-muted); font-size: 13px;">Lịch sử / Phản hồi</span>
                                <span class="info-value" style="white-space: pre-wrap; font-size: 14px; color: var(--primary);">@req.Resolution</span>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(req.ImageUrls))
                        {
                            var images = req.ImageUrls.Split(',');
                            <div class="info-row" style="margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
                                <span class="info-label" style="color: var(--text-muted); font-size: 13px; display: block; margin-bottom: 8px;"><i data-feather="image" style="width: 14px; margin-right: 4px;"></i>Hình ảnh minh họa</span>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                    @foreach (var img in images)
                                    {
                                        <div style="position: relative; border-radius: 6px; overflow: hidden; padding-top: 100%; border: 1px solid var(--border);">
                                            <a href="@img" target="_blank">
                                                <img src="@img" alt="Attached" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" />
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('detailModal-@req.Id')">Đóng</button>
                </div>
            </div>
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            @if(TempData["SuccessMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: '@Html.Raw(TempData["SuccessMessage"])',
                    confirmButtonColor: '#3085d6'
                });
                </text>
            }
            @if(TempData["ErrorMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: '@Html.Raw(TempData["ErrorMessage"])',
                    confirmButtonColor: '#d33'
                });
                </text>
            }
        });

        function filterRequests() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            var activeStatus = document.querySelector('.filter-btn.btn-primary').getAttribute('data-status');
            
            var rows = document.querySelectorAll('.maintenance-row');
            rows.forEach(function(row) {
                var text = row.getAttribute('data-search');
                var status = row.getAttribute('data-status');
                
                var matchSearch = search === "" || text.includes(search);
                var matchStatus = activeStatus === "All" || status === activeStatus;
                
                if (matchSearch && matchStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function setStatusFilter(status, btn) {
            document.querySelectorAll('.filter-btn').forEach(function(b) {
                b.classList.remove('btn-primary');
                b.classList.add('btn-ghost');
            });
            btn.classList.remove('btn-ghost');
            btn.classList.add('btn-primary');
            filterRequests();
        }

        function openDetailModal(id) {
            document.getElementById('detailModal-' + id).style.display = 'flex';
        }

        function openCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function updatePropertyId() {
            var select = document.getElementById('leaseSelect');
            var selectedOption = select.options[select.selectedIndex];
            var propId = selectedOption.getAttribute('data-propertyid');
            document.getElementById('propertyIdInput').value = propId;
        }

        function confirmCreate() {
            var form = document.getElementById('createForm');
            if(form.reportValidity()) {
                updatePropertyId();
                if(document.getElementById('propertyIdInput').value === "") {
                    Swal.fire('Lỗi', 'Vui lòng chọn bất động sản hợp lệ', 'error');
                    return;
                }
                
                Swal.fire({
                    title: 'Xác nhận gửi yêu cầu?',
                    text: "Chủ nhà sẽ nhận được thông báo về sự cố này",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Gửi',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            }
        }

        function handleImageUpload(event) {
            var files = event.target.files;
            var container = document.getElementById('image-preview-container');
            
            if (files.length > 0) {
                container.style.display = 'grid';
                container.innerHTML = ''; // Clear old preview
                
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    if (file.type.match('image.*')) {
                        var reader = new FileReader();
                        reader.onload = (function(f) {
                            return function(e) {
                                var div = document.createElement('div');
                                div.style.position = 'relative';
                                div.style.borderRadius = '6px';
                                div.style.overflow = 'hidden';
                                div.style.paddingTop = '100%';
                                div.style.border = '1px solid var(--border)';
                                
                                var img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.position = 'absolute';
                                img.style.top = '0';
                                img.style.left = '0';
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                
                                div.appendChild(img);
                                container.appendChild(div);
                            };
                        })(file);
                        reader.readAsDataURL(file);
                    }
                }
            } else {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
    </script>
}
